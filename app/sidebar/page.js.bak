"use client";

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
import confetti from 'canvas-confetti';
import { mostrarElemento, esDocente, esControl } from '../components/PermisosHelper';
import { getFormValue, isFormAvailable } from '../components/SafeFormAccess';
import { formatearNombreCompleto } from '../components/FormatearNombre';
import StudentNameDisplay, { formatFullName } from '../components/StudentNameDisplay';
import GestionRepresentante from '../components/GestionRepresentante';

export default function SidebarPage() {
  // Estados para manejar los datos y la interfaz
  const [activeTab, setActiveTab] = useState('asignaciones'); // Iniciar con asignaciones como pestaña activa por defecto
  const [userType, setUserType] = useState(null); // Estado para almacenar el tipo de usuario
  const [userData, setUserData] = useState(null);
  const [institucion, setInstitucion] = useState('');
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const router = useRouter();
  
  // Estados para gestión de datos
  const [docentes, setDocentes] = useState([]);
  const [alumnos, setAlumnos] = useState([]);
  const [materias, setMaterias] = useState([]);
  const [asignaciones, setAsignaciones] = useState([]);
  const [periodos, setPeriodos] = useState([]);
  const [periodoActual, setPeriodoActual] = useState(null);
  const [updatingEstado, setUpdatingEstado] = useState(false);
  
  // Estados para modales
  const [showModal, setShowModal] = useState(false);
  const [modalType, setModalType] = useState('');
  const [modalData, setModalData] = useState(null);
  
  // Efecto para cerrar el modal al cargar la página
  useEffect(() => {
    setShowModal(false);
    setModalType('');
    setModalData(null);
  }, []);
  
  // Efecto para cargar los datos del usuario y establecer la pestaña activa adecuada
  useEffect(() => {
    try {
      // Intentar obtener el tipo de usuario
      const userTypeCookie = document.cookie
        .split('; ')
        .find(row => row.startsWith('userType='));
      
      if (userTypeCookie) {
        const tipo = userTypeCookie.split('=')[1];
        setUserType(tipo);
        
        // Si es docente, establecer asignaciones como pestaña activa por defecto
        if (tipo === 'docente') {
          setActiveTab('asignaciones');
          console.log('Usuario docente detectado, mostrando solo asignaciones');
        } else if (tipo === 'control') {
          // Si es control, puede iniciar en docentes
          setActiveTab('docentes');
          console.log('Usuario control detectado, mostrando todas las opciones');
        }
      } else {
        // Si no hay tipo de usuario, establecer asignaciones como pestaña activa por defecto
        setActiveTab('asignaciones');
        setUserType('alumno'); // Valor por defecto
        console.log('Tipo de usuario no detectado, usando asignaciones como pestaña por defecto');
      }
    } catch (error) {
      console.error('Error al obtener el tipo de usuario:', error);
      // Por defecto, mostrar asignaciones
      setActiveTab('asignaciones');
      setUserType('alumno'); // Valor por defecto en caso de error
    }
  }, []);
  
  // Estados para formularios
  const [formData, setFormData] = useState({});
  
  // Estados para búsqueda y filtrado
  const [searchTerm, setSearchTerm] = useState('');
  const [searchNombre, setSearchNombre] = useState('');
  const [searchCedula, setSearchCedula] = useState('');
  const [showStudentForm, setShowStudentForm] = useState(false);
  const [showConfetti, setShowConfetti] = useState(false);
  const [searchAlumno, setSearchAlumno] = useState(''); // Estado para buscar alumnos en el formulario de asignaciones
  const [searchAlumnoSelector, setSearchAlumnoSelector] = useState(''); // Estado para buscar alumnos en el selector individual
  const [searchPeriodo, setSearchPeriodo] = useState(''); // Estado para filtrar por periodo
  const [searchAnio, setSearchAnio] = useState(''); // Estado para filtrar por año
  
  // Estados para reportes
  const [generandoReporte, setGenerandoReporte] = useState(false);
  const [tipoReporte, setTipoReporte] = useState('estudiantes');
  
  // Estados para profesores
  const [profesores, setProfesores] = useState([]);
  const [searchProfesorNombre, setSearchProfesorNombre] = useState('');
  const [searchProfesorCedula, setSearchProfesorCedula] = useState('');
  const [showProfesorForm, setShowProfesorForm] = useState(false);
  const [profesorFormData, setProfesorFormData] = useState({
    nombre: '',
    apellido: '',
    cedula: 'N/P',
    email: '',
    telefono: '',
    especialidad: '',
    fechaIngreso: '',
    modoEdicion: false
  });
  
  // Estados adicionales para materias
  const [searchMateriaNombre, setSearchMateriaNombre] = useState('');
  const [searchMateriaCodigo, setSearchMateriaCodigo] = useState('');
  const [showMateriaForm, setShowMateriaForm] = useState(false);
  const [materiaFormData, setMateriaFormData] = useState({
    codigo: '',
    nombre: '',
    descripcion: '',
    modoEdicion: false
  });
  
  // Estados adicionales para asignaciones
  const [showAsignacionForm, setShowAsignacionForm] = useState(false);
  const [showActividadForm, setShowActividadForm] = useState(false);
  const [asignacionSeleccionada, setAsignacionSeleccionada] = useState(null);
  const [alumnoSeleccionado, setAlumnoSeleccionado] = useState('');
  const [asignacionFormData, setAsignacionFormData] = useState({
    materiaId: '',
    profesorId: '',
    alumnos: [],
    periodo: '',
    anio: '1 año',
    modoEdicion: false,
    usarPeriodoExistente: false
  });
  const [actividadFormData, setActividadFormData] = useState({
    nombre: '',
    descripcion: '',
    fecha: new Date().toISOString().split('T')[0],
    porcentaje: 0
  });
  
  // Funciones para manejar eventos de formularios

  // Función para manejar el cierre de sesión
  const handleLogout = () => {
    // Eliminar datos de sesión
    sessionStorage.removeItem('userId');
    sessionStorage.removeItem('userType');
    sessionStorage.removeItem('userName');
    sessionStorage.removeItem('userLastName');
    
    // Eliminar datos de localStorage si existen
    localStorage.removeItem('userId');
    localStorage.removeItem('userType');
    localStorage.removeItem('userName');
    localStorage.removeItem('userLastName');
    
    // Redirigir al usuario a la página de inicio de sesión
    router.push('/');
  };

  // Función para cambiar el periodo educativo seleccionado
  const handlePeriodChange = (periodoId) => {
    // Encontrar el periodo seleccionado en la lista de periodos
    const periodoSeleccionado = periodos.find(p => p.id === periodoId);
    
    if (periodoSeleccionado) {
      // Actualizar el periodo actual
      setPeriodoActual(periodoSeleccionado);
      
      // Cargar los datos correspondientes al periodo seleccionado
      loadPeriodData(periodoSeleccionado);
    }
  };

  // Funciones para gestionar periodos educativos
  const handleAddPeriodo = (e) => {
    if (e) e.preventDefault();
    try {
      setLoading(true);
      
      // Crear nuevo periodo con los datos del formulario
      const nuevoPeriodo = {
        id: `P${formData.anio}-${formData.numero}`,
        nombre: `Periodo ${formData.anio}-${formData.numero}`,
        fechaInicio: formData.fechaInicio,
        fechaFin: formData.fechaFin,
        activo: formData.activo || false
      };
      
      // Si el nuevo periodo es activo, desactivar los demás
      let periodosActualizados = [...periodos];
      if (nuevoPeriodo.activo) {
        periodosActualizados = periodosActualizados.map(p => ({
          ...p,
          activo: false
        }));
      }
      
      // Añadir el nuevo periodo a la lista
      setPeriodos([...periodosActualizados, nuevoPeriodo]);
      
      // Si es el único periodo o es activo, establecerlo como actual
      if (nuevoPeriodo.activo || periodosActualizados.length === 0) {
        setPeriodoActual(nuevoPeriodo);
        loadPeriodData(nuevoPeriodo);
      }
      
      setShowModal(false);
      setFormData({});
      setLoading(false);
    } catch (err) {
      console.error('Error al agregar periodo:', err);
      setError('Error al agregar periodo. Por favor, intente de nuevo más tarde.');
      setLoading(false);
    }
  };

  const handleEditPeriodo = (e, periodoId) => {
    if (e) e.preventDefault();
    try {
      setLoading(true);
      
      // Crear objeto con datos actualizados
      const periodoEditado = {
        id: periodoId || formData.id,
        nombre: `Periodo ${formData.anio}-${formData.numero}`,
        fechaInicio: formData.fechaInicio,
        fechaFin: formData.fechaFin,
        activo: formData.activo || false
      };
      
      // Si el periodo editado es activo, desactivar los demás
      let periodosActualizados = [...periodos];
      if (periodoEditado.activo) {
        periodosActualizados = periodosActualizados.map(p => ({
          ...p,
          activo: p.id === periodoEditado.id ? true : false
        }));
      } else {
        periodosActualizados = periodosActualizados.map(p => ({
          ...p,
          activo: p.id === periodoEditado.id ? false : p.activo
        }));
      }
      
      // Actualizar la lista de periodos
      setPeriodos(periodosActualizados.map(p => 
        p.id === periodoEditado.id ? periodoEditado : p
      ));
      
      // Si el periodo editado es el actual o es activo, actualizarlo
      if (periodoActual?.id === periodoEditado.id || periodoEditado.activo) {
        setPeriodoActual(periodoEditado);
        loadPeriodData(periodoEditado);
      }
      
      setShowModal(false);
      setFormData({});
      setLoading(false);
    } catch (err) {
      console.error('Error al editar periodo:', err);
      setError('Error al editar periodo. Por favor, intente de nuevo más tarde.');
      setLoading(false);
    }
  };

  const handleDeletePeriodo = (periodoId) => {
    try {
      setLoading(true);
      
      // Verificar que no sea el único periodo
      if (periodos.length <= 1) {
        setError('No se puede eliminar el único periodo existente.');
        setLoading(false);
        return;
      }
      
      // Obtener el periodo a eliminar
      const periodoAEliminar = periodos.find(p => p.id === periodoId);
      
      // Filtrar la lista de periodos
      const periodosActualizados = periodos.filter(p => p.id !== periodoId);
      setPeriodos(periodosActualizados);
      
      // Si el periodo eliminado era el actual, establecer otro como actual
      if (periodoActual?.id === periodoId) {
        const nuevoPeriodoActual = periodosActualizados.find(p => p.activo) || periodosActualizados[0];
        setPeriodoActual(nuevoPeriodoActual);
        loadPeriodData(nuevoPeriodoActual);
      }
      
      setLoading(false);
    } catch (err) {
      console.error('Error al eliminar periodo:', err);
      setError('Error al eliminar periodo. Por favor, intente de nuevo más tarde.');
      setLoading(false);
    }
  };
  

  // Efecto para verificar autenticación y cargar datos iniciales
  useEffect(() => {
    const checkAuth = async () => {
      try {
        setLoading(true);
        console.log('Verificando autenticación en sidebar...');
        
        // Obtener información del usuario desde sessionStorage o localStorage
        const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
        const userType = sessionStorage.getItem('userType') || localStorage.getItem('userType');
        const userName = sessionStorage.getItem('userName') || localStorage.getItem('userName');
        const userLastName = sessionStorage.getItem('userLastName') || localStorage.getItem('userLastName');
        
        console.log('Datos de usuario recuperados:', {
          userId,
          userType,
          userName,
          userLastName
        });
        
        // Verificar si hay información de usuario
        if (!userId) {
          console.log('No se encontró ID de usuario en la sesión');
          // Si no hay ID de usuario, redirigir al login
          router.push('/');
          return;
        }
        
        // Obtener identificadores de institución
        const idIdentificador = localStorage.getItem('idID') || sessionStorage.getItem('idID');
        const idI = localStorage.getItem('idI') || sessionStorage.getItem('idI');
        const idA = localStorage.getItem('idA') || sessionStorage.getItem('idA');
        const idAD = localStorage.getItem('idAD') || sessionStorage.getItem('idAD');
        
        console.log('Identificadores de institución:', { idID: idIdentificador, idI, idA, idAD });
        
        // Determinar la institución
        let institucionActual = '';
        if (idIdentificador) {
          console.log('%cInstitución determinada: IUTCM (por idID)', 'background: #2ecc71; color: white; padding: 4px; border-radius: 3px;');
          institucionActual = 'IUTCM';
        } else if (idI) {
          console.log('%cInstitución determinada: IUTCM (por idI)', 'background: #2ecc71; color: white; padding: 4px; border-radius: 3px;');
          institucionActual = 'IUTCM';
        } else if (idAD) {
          console.log('%cInstitución determinada: Acacias (por idAD)', 'background: #f39c12; color: white; padding: 4px; border-radius: 3px;');
          institucionActual = 'Acacias';
        } else if (idA) {
          console.log('%cInstitución determinada: Acacias (por idA)', 'background: #f39c12; color: white; padding: 4px; border-radius: 3px;');
          institucionActual = 'Acacias';
        } else {
          console.log('%cNo se encontró ningún identificador de institución', 'background: #e74c3c; color: white; padding: 4px; border-radius: 3px;');
        }
        
        // Establecer la institución en el estado
        setInstitucion(institucionActual);
        
        // Establecer los datos del usuario
        setUserData({
          id: userId,
          tipo: userType,
          nombre: userName || 'Usuario',
          apellido: userLastName || '',
          idA: idA,
          idI: idI,
          idID: idIdentificador,
          idAD: idAD
        });
        
        setLoading(false);

        // Verificar si el tipo de usuario es control o docente
        if (userType && userType !== 'control' && userType !== 'docente') {
          console.log('Tipo de usuario incorrecto:', userType);
          // Si el tipo de usuario no es control o docente, redirigir a la página correspondiente
          router.push(userType === 'alumno' ? '/alumno' : '/');
          return;
        }

        console.log('Usuario autenticado correctamente como:', userType);
        
        // Ya no necesitamos obtener idID aquí, ya se hizo anteriormente
        console.log('Valor de idID ya obtenido:', idIdentificador);
        
        // Establecer datos del usuario desde la sesión
        setUserData({
          id: userId,
          tipo: userType,
          nombre: userName || 'Usuario',
          apellido: userLastName || '',
          idA: idA || null,
          idI: idI || null,
          idID: idIdentificador || null
        });
        
        console.log('Datos de usuario establecidos:', {
          id: userId,
          tipo: userType,
          idA: idA || null,
          idI: idI || null,
          idID: idIdentificador || null
        });
        
        // Simular carga de periodos educativos
        const periodosDemo = [
          { id: 'P2025-1', nombre: 'Periodo 2025-1', fechaInicio: '2025-01-15', fechaFin: '2025-06-30', activo: true },
          { id: 'P2024-2', nombre: 'Periodo 2024-2', fechaInicio: '2024-07-15', fechaFin: '2024-12-15', activo: false },
        ];
        
        setPeriodos(periodosDemo);
        setPeriodoActual(periodosDemo.find(p => p.activo) || periodosDemo[0]);
        
        // Cargar datos según el periodo actual
        await loadPeriodData(periodosDemo.find(p => p.activo) || periodosDemo[0]);
        
        setLoading(false);
      } catch (err) {
        console.error('Error al verificar autenticación:', err);
        setError('Error al cargar los datos. Por favor, intente de nuevo más tarde.');
        setLoading(false);
      }
    };

    checkAuth();
  }, [router]);
  
  // Efecto para cargar datos de materias cuando se selecciona la pestaña de materias
  useEffect(() => {
    if (activeTab === 'materias') {
      loadMaterias();
    }
  }, [activeTab]);
  
  // Función para cargar profesores
  const loadProfesores = async () => {
    try {
      console.log('Cargando profesores...');
      
      // Obtener el ID del usuario actual
      const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
      if (!userId) {
        setError('No se pudo identificar al usuario. Por favor, inicie sesión nuevamente.');
        return;
      }
      
      // Cargar profesores desde la API
      const response = await fetch(`/api/profesores?creadorId=${userId}`);
      
      if (!response.ok) {
        throw new Error(`Error al cargar profesores: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('Profesores cargados:', data);
      
      if (data.success && data.data) {
        // Transformar los datos para que coincidan con el formato esperado
        const profesoresFormateados = data.data.map(profesor => {
          // Preservar la fecha de ingreso exactamente como está almacenada
          let fechaIngreso = '';
          if (profesor.fechaIngreso) {
            // Extraer la fecha directamente de la cadena ISO sin modificarla
            const fechaISO = profesor.fechaIngreso.split('T')[0]; // Obtener solo la parte de la fecha (YYYY-MM-DD)
            fechaIngreso = fechaISO;
          }
          
          return {
            _id: profesor._id,
            id: profesor._id,
            cedula: profesor.idU || 'N/P',
            nombre: profesor.nombre || '',
            apellido: profesor.apellido || '',
            email: profesor.email || '',
            telefono: profesor.telefono || '',
            especialidad: profesor.especialidad || '',
            fechaIngreso: fechaIngreso
          };
        });
        
        setProfesores(profesoresFormateados);
      }
    } catch (err) {
      console.error('Error al cargar profesores:', err);
      setError('Error al cargar profesores. Por favor, intente de nuevo más tarde.');
    }
  };
  
  // Función para cargar estudiantes
  const loadEstudiantes = async () => {
    try {
      console.log('Cargando estudiantes...');
      
      // Obtener el ID del usuario actual
      const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
      if (!userId) {
        setError('No se pudo identificar al usuario. Por favor, inicie sesión nuevamente.');
        return;
      }
      
      // Cargar estudiantes desde la API
      const response = await fetch(`/api/estudiantes?creadorId=${userId}`);
      
      if (!response.ok) {
        throw new Error(`Error al cargar estudiantes: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('Estudiantes cargados:', data);
      
      if (data.success && data.data) {
        // Transformar los datos para que coincidan con el formato esperado
        const estudiantesFormateados = data.data.map(estudiante => ({
          _id: estudiante._id,
          id: estudiante._id,
          cedula: estudiante.idU || 'N/P',
          nombre: estudiante.nombre || '',
          apellido: estudiante.apellido || '',
          fechaNacimiento: estudiante.fechaNacimiento,
          lugarNacimiento: estudiante.lugarNacimiento || '',
          sexo: estudiante.sexo || 'Otro',
          grupo: estudiante.grupo || '',
          ef: estudiante.ef || '',
          edad: estudiante.edad,
          esMenorDeEdad: estudiante.esMenorDeEdad,
          estado: estudiante.estado !== undefined ? estudiante.estado : 1 // Incluir el campo estado, por defecto 1 (activo)
        }));
        
        setAlumnos(estudiantesFormateados);
      }
    } catch (err) {
      console.error('Error al cargar estudiantes:', err);
      setError('Error al cargar estudiantes. Por favor, intente de nuevo más tarde.');
    }
  };
  
  // Efecto para cargar datos de asignaciones cuando se selecciona la pestaña de asignaciones
  useEffect(() => {
    if (activeTab === 'asignaciones') {
      // Cargar todos los datos necesarios para la pestaña de asignaciones
      const loadAllData = async () => {
        try {
          setLoading(true);
          console.log('Cargando todos los datos necesarios para asignaciones...');
          
          // Cargar materias, docentes y alumnos en paralelo
          await Promise.all([
            loadMaterias(),
            loadProfesores(),
            loadEstudiantes(),
            loadAsignaciones()
          ]);
          
          setLoading(false);
        } catch (error) {
          console.error('Error al cargar datos para asignaciones:', error);
          setError('Error al cargar datos. Por favor, intente de nuevo.');
          setLoading(false);
        }
      };
      
      loadAllData();
    } else if (activeTab === 'reportes') {
      // También cargar todos los datos necesarios para la pestaña de reportes
      const loadReportData = async () => {
        try {
          setLoading(true);
          console.log('Cargando datos necesarios para reportes...');
          
          // Cargar asignaciones, materias y docentes en paralelo
          await Promise.all([
            loadMaterias(),
            loadProfesores(),
            loadAsignaciones()
          ]);
          
          setLoading(false);
        } catch (error) {
          console.error('Error al cargar datos para reportes:', error);
          setError('Error al cargar datos. Por favor, intente de nuevo.');
          setLoading(false);
        }
      };
      
      loadReportData();
    }
  }, [activeTab]);

  // Efecto para cargar datos de profesores cuando se selecciona la pestaña de docentes
  useEffect(() => {
    if (activeTab === 'docentes') {
      setLoading(true);
      loadProfesores()
        .then(() => setLoading(false))
        .catch(err => {
          console.error('Error al cargar profesores:', err);
          setError('Error al cargar profesores. Por favor, intente de nuevo más tarde.');
          setLoading(false);
        });
    }
  }, [activeTab]);

  // Efecto para cargar estudiantes cuando se selecciona la pestaña de alumnos
  useEffect(() => {
    if (activeTab === 'alumnos') {
      setLoading(true);
      loadEstudiantes()
        .then(() => setLoading(false))
        .catch(err => {
          console.error('Error al cargar estudiantes:', err);
          setError('Error al cargar estudiantes. Por favor, intente de nuevo más tarde.');
          setLoading(false);
        });
    }
  }, [activeTab]);

  // Función para cargar datos de un periodo específico
  const loadPeriodData = async (periodo) => {
    try {
      console.log('Cargando datos para el periodo:', periodo.id);
      setLoading(true);
      
      // Obtener el ID del usuario de la sesión
      const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
      if (!userId) {
        console.error('No se encontró ID de usuario en la sesión');
        setError('Sesión no válida. Por favor, inicie sesión nuevamente.');
        setLoading(false);
        router.push('/');
        return;
      }
      
      console.log('Cargando datos del usuario con ID:', userId);
      
      // Cargar datos del usuario desde MongoDB
      const responseUsuario = await fetch(`/api/alumnos?userId=${userId}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      });
      
      if (!responseUsuario.ok) {
        throw new Error(`Error al cargar datos de usuario: ${responseUsuario.statusText}`);
      }
      
      const usuarioData = await responseUsuario.json();
      console.log('Datos de usuario cargados desde MongoDB:', usuarioData);
      
      if (!usuarioData.success || !usuarioData.data || usuarioData.data.length === 0) {
        throw new Error('No se pudieron cargar los datos del usuario');
      }
      
      // Actualizar los datos del usuario en el estado
      const usuario = usuarioData.data[0];
      setUserData({
        id: usuario.idU,
        tipo: usuario.tipo,
        nombre: usuario.nombre || 'Usuario',
        apellido: usuario.apellido || '',
        email: usuario.email || '',
        telefono: usuario.telefono || ''
      });
      
      // Si el usuario es de tipo 'control' o 'docente', cargar datos de alumnos para gestión
      if (usuario.tipo === 'control' || usuario.tipo === 'docente') {
        // Simular carga de alumnos para gestión
        const alumnosDemo = [
          { id: 'ALU123', cedula: 'V98765432', nombre: 'Ana', apellido: 'Martínez', email: 'ana.martinez@ejemplo.com', telefono: '04121234567' },
          { id: 'ALU456', cedula: 'V87654321', nombre: 'Pedro', apellido: 'Sánchez', email: 'pedro.sanchez@ejemplo.com', telefono: '04241234567' },
          { id: 'ALU789', cedula: 'V76543210', nombre: 'Laura', apellido: 'Díaz', email: 'laura.diaz@ejemplo.com', telefono: '04161234567' },
        ];
        setAlumnos(alumnosDemo);
      } else {
        // Si es alumno, solo mostrar sus propios datos
        const alumnoFormateado = {
          id: usuario._id || usuario.idU,
          cedula: usuario.idU,
          nombre: usuario.nombre || '',
          apellido: usuario.apellido || '',
          email: usuario.email || '',
          telefono: usuario.telefono || '',
          fechaNacimiento: usuario.fechaNacimiento || ''
        };
        setAlumnos([alumnoFormateado]);
      }
      
      // Por ahora, seguimos usando datos de demostración para docentes y materias
      const docentesDemo = [
        { id: 'DOC123', cedula: 'V12345678', nombre: 'Juan', apellido: 'Pérez', email: 'juan.perez@ejemplo.com', telefono: '04121234567' },
        { id: 'DOC456', cedula: 'V87654321', nombre: 'María', apellido: 'González', email: 'maria.gonzalez@ejemplo.com', telefono: '04241234567' },
        { id: 'DOC789', cedula: 'V23456789', nombre: 'Carlos', apellido: 'Rodríguez', email: 'carlos.rodriguez@ejemplo.com', telefono: '04161234567' },
      ];
      
      const materiasDemo = [
        { id: 'MAT123', codigo: 'MAT101', nombre: 'Matemáticas I', descripcion: 'Introducción al cálculo diferencial' },
        { id: 'MAT456', codigo: 'FIS101', nombre: 'Física I', descripcion: 'Mecánica clásica' },
        { id: 'MAT789', codigo: 'QUI101', nombre: 'Química I', descripcion: 'Química general' },
      ];
      
      // Crear asignaciones basadas en el tipo de usuario
      let asignacionesDemo = [];
      
      if (usuario.tipo === 'alumno') {
        // Si es alumno, mostrar solo sus asignaciones
        asignacionesDemo = [
          { 
            id: 'ASG123', 
            docenteId: 'DOC123', 
            materiaId: 'MAT123', 
            periodoId: periodo.id,
            alumnos: [usuario.idU],
            actividades: [
              { 
                id: 'ACT123', 
                nombre: 'Examen Parcial 1', 
                descripcion: 'Primer examen parcial', 
                fecha: '2025-03-15',
                calificaciones: [
                  { alumnoId: usuario.idU, nota: 15 }
                ]
              },
              { 
                id: 'ACT456', 
                nombre: 'Trabajo Práctico', 
                descripcion: 'Trabajo práctico sobre derivadas', 
                fecha: '2025-04-10',
                calificaciones: [
                  { alumnoId: usuario.idU, nota: 17 }
                ]
              }
            ]
          },
          { 
            id: 'ASG456', 
            docenteId: 'DOC456', 
            materiaId: 'MAT456', 
            periodoId: periodo.id,
            alumnos: [usuario.idU],
            actividades: [
              { 
                id: 'ACT789', 
                nombre: 'Examen Parcial 1', 
                descripcion: 'Primer examen parcial', 
                fecha: '2025-03-20',
                calificaciones: [
                  { alumnoId: usuario.idU, nota: 18 }
                ]
              }
            ]
          }
        ];
      } else {
        // Si es docente o control, mostrar todas las asignaciones
        asignacionesDemo = [
          { 
            id: 'ASG123', 
            docenteId: 'DOC123', 
            materiaId: 'MAT123', 
            periodoId: periodo.id,
            alumnos: ['ALU123', 'ALU456'],
            actividades: [
              { 
                id: 'ACT123', 
                nombre: 'Examen Parcial 1', 
                descripcion: 'Primer examen parcial', 
                fecha: '2025-03-15',
                calificaciones: [
                  { alumnoId: 'ALU123', nota: 15 },
                  { alumnoId: 'ALU456', nota: 18 },
                ]
              },
              { 
                id: 'ACT456', 
                nombre: 'Trabajo Práctico', 
                descripcion: 'Trabajo práctico sobre derivadas', 
                fecha: '2025-04-10',
                calificaciones: [
                  { alumnoId: 'ALU123', nota: 17 },
                  { alumnoId: 'ALU456', nota: 16 },
                ]
              }
            ]
          },
          { 
            id: 'ASG456', 
            docenteId: 'DOC456', 
            materiaId: 'MAT456', 
            periodoId: periodo.id,
            alumnos: ['ALU456', 'ALU789'],
            actividades: [
              { 
                id: 'ACT789', 
                nombre: 'Examen Parcial 1', 
                descripcion: 'Primer examen parcial', 
                fecha: '2025-03-20',
                calificaciones: [
                  { alumnoId: 'ALU456', nota: 14 },
                  { alumnoId: 'ALU789', nota: 19 },
                ]
              }
            ]
          }
        ];
      }
      
      setDocentes(docentesDemo);
      setMaterias(materiasDemo);
      setAsignaciones(asignacionesDemo);
      setLoading(false);
      
    } catch (err) {
      console.error('Error al cargar datos del periodo:', err);
      setError(`Error al cargar los datos del periodo ${periodo.nombre}. Por favor, intente de nuevo más tarde.`);
      setLoading(false);
    }
  };

  // Funciones para gestionar docentes
  const handleAddDocente = (e) => {
    if (e) e.preventDefault();
    try {
      setLoading(true);
      // Aquí iría la lógica para agregar un docente a la base de datos
      const nuevoDocente = {
        id: `DOC${Date.now()}`,
        cedula: formData.cedula,
        nombre: formData.nombre,
        apellido: formData.apellido,
        email: formData.email,
        telefono: formData.telefono,
        fechaIngreso: formData.fechaIngreso || null
      };
      
      setDocentes([...docentes, nuevoDocente]);
      setShowModal(false);
      setFormData({});
      setLoading(false);
    } catch (err) {
      console.error('Error al agregar docente:', err);
      setError('Error al agregar docente. Por favor, intente de nuevo más tarde.');
      setLoading(false);
    }
  };
  
  
  // Función para manejar cambios en los campos del formulario de profesores
  const handleProfesorFormChange = (e) => {
    const { name, value } = e.target;
    // Para fechas, asegurarse de que se guarde como una cadena de fecha válida
    if (name === 'fechaIngreso') {
      console.log('Fecha de ingreso seleccionada:', value);
    }
    setProfesorFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };
  
  const handleEditDocente = (e, docenteId) => {
    if (e) e.preventDefault();
    try {
      setLoading(true);
      // Aquí iría la lógica para editar un docente en la base de datos
      const docenteEditado = {
        id: docenteId || formData.id,
        cedula: formData.cedula,
        nombre: formData.nombre,
        apellido: formData.apellido,
        email: formData.email,
        telefono: formData.telefono,
        fechaIngreso: formData.fechaIngreso || null
      };
      
      const nuevosDocentes = docentes.map(doc => 
        doc.id === (docenteId || formData.id) ? docenteEditado : doc
      );
      
      setDocentes(nuevosDocentes);
      setShowModal(false);
      setFormData({});
      setLoading(false);
    } catch (err) {
      console.error('Error al editar docente:', err);
      setError('Error al editar docente. Por favor, intente de nuevo más tarde.');
      setLoading(false);
    }
  };

  const handleDeleteDocente = (docenteId) => {
    if (window.confirm('¿Está seguro de eliminar este docente?')) {
      try {
        setLoading(true);
        // Aquí iría la lógica para eliminar un docente de la base de datos
        const nuevosDocentes = docentes.filter(doc => doc.id !== docenteId);
        setDocentes(nuevosDocentes);
        setLoading(false);
      } catch (err) {
        console.error('Error al eliminar docente:', err);
        setError('Error al eliminar docente. Por favor, intente de nuevo más tarde.');
        setLoading(false);
      }
    }
  };

  // Función para agregar un nuevo profesor
  const handleAddProfesor = async (e) => {
    if (e) e.preventDefault();
    try {
      setLoading(true);
      console.log('Agregando profesor con datos:', profesorFormData);
      
      if (!profesorFormData.nombre || !profesorFormData.apellido) {
        // Mensaje: Por favor, complete todos los campos requeridos.
        setError('Por favor, complete todos los campos requeridos.');
        setLoading(false);
        return;
      }
      
      // Obtener el ID del usuario actual
      const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
      const userType = sessionStorage.getItem('userType') || localStorage.getItem('userType');
      
      // Obtener el valor de la institución desde el DOM
      const institucionElement = document.getElementById('institucion');
      const institucion = institucionElement ? institucionElement.textContent.trim() : '';
      console.log('Institución detectada:', institucion);
      
      if (!userId) {
        // Mensaje: No se pudo identificar al usuario actual. Por favor, inicie sesión nuevamente.
        setError('No se pudo identificar al usuario actual. Por favor, inicie sesión nuevamente.');
        setLoading(false);
        return;
      }
      
      // Crear objeto del nuevo profesor
      const nuevoProfesor = {
        cedula: profesorFormData.cedula || 'N/P',
        nombre: profesorFormData.nombre,
        apellido: profesorFormData.apellido,
        email: profesorFormData.email || '',
        telefono: profesorFormData.telefono || '',
        especialidad: profesorFormData.especialidad || '',
        fechaIngreso: profesorFormData.fechaIngreso || null,
        userId: userId,
        userType: userType,
        institucion: institucion // Incluir la institución en la solicitud
      };
      
      console.log('Enviando datos al servidor:', nuevoProfesor);
      
      // Mostrar alerta para confirmar
      // Proceder sin confirmación
      if (false) {
        setLoading(false);
        return;
      }
      
      // Enviar datos a la API para guardar en MongoDB
      const response = await fetch('/api/profesores', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(nuevoProfesor),
      });
      
      const responseData = await response.json();
      console.log('Respuesta del servidor:', responseData);
      
      if (!response.ok) {
        throw new Error(responseData.message || 'Error al agregar profesor');
      }
      
      // Mostrar alerta de éxito
      // Mensaje: Profesor agregado correctamente
      
      // Limpiar el formulario
      setProfesorFormData({
        nombre: '',
        apellido: '',
        cedula: 'N/P',
        email: '',
        telefono: '',
        especialidad: '',
        fechaIngreso: '',
        modoEdicion: false
      });
      
      // Ocultar el formulario
      setShowProfesorForm(false);
      
      // Recargar la lista de profesores inmediatamente
      try {
        const response = await fetch(`/api/profesores?creadorId=${userId}`);
        
        if (response.ok) {
          const data = await response.json();
          console.log('Datos de profesores cargados:', data);
          if (data.success && data.data) {
            const profesoresFormateados = data.data.map(profesor => ({
              _id: profesor._id,
              id: profesor._id,
              cedula: profesor.idU || 'N/P',
              nombre: profesor.nombre || '',
              apellido: profesor.apellido || '',
              email: profesor.email || '',
              telefono: profesor.telefono || '',
              especialidad: profesor.especialidad || '',
              fechaIngreso: profesor.fechaIngreso || null
            }));
            
            setProfesores(profesoresFormateados);
          }
        }
      } catch (error) {
        console.error('Error al recargar profesores:', error);
      }
      
      setLoading(false);
      
    } catch (err) {
      console.error('Error al agregar profesor:', err);
      setError('Error al agregar profesor: ' + (err.message || 'Por favor, intente de nuevo más tarde.'));
      setLoading(false);
      // Mensaje de error: Error al agregar profesor
    }
  };

  // Función para editar un profesor existente
  const handleEditProfesor = async (e) => {
    if (e) e.preventDefault();
    try {
      setLoading(true);
      console.log('Editando profesor con datos:', profesorFormData);
      
      if (!profesorFormData.nombre || !profesorFormData.apellido) {
        setError('Por favor, complete todos los campos requeridos.');
        setLoading(false);
        return;
      }
      
      // Obtener el ID del profesor a editar
      const profesorId = profesorFormData.id || profesorFormData._id;
      if (!profesorId) {
        setError('No se pudo identificar el ID del profesor a editar.');
        setLoading(false);
        return;
      }
      
      // Obtener el ID del usuario actual
      const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
      const userType = sessionStorage.getItem('userType') || localStorage.getItem('userType');
      
      // Obtener el valor de la institución desde el DOM
      const institucionElement = document.getElementById('institucion');
      const institucion = institucionElement ? institucionElement.textContent.trim() : '';
      console.log('Institución detectada para edición:', institucion);
      
      // Crear objeto del profesor editado
      const profesorEditado = {
        nombre: profesorFormData.nombre,
        apellido: profesorFormData.apellido,
        email: profesorFormData.email || '',
        telefono: profesorFormData.telefono || '',
        especialidad: profesorFormData.especialidad || '',
        fechaIngreso: profesorFormData.fechaIngreso || null,
        institucion: institucion
      };
      
      // Solo incluir cédula si no es 'N/P'
      if (profesorFormData.cedula && profesorFormData.cedula !== 'N/P') {
        profesorEditado.idU = profesorFormData.cedula;
      }
      
      console.log('Enviando datos al servidor para editar:', profesorEditado);
      
      // Mostrar alerta para confirmar
      // Proceder sin confirmación
      if (false) {
        setLoading(false);
        return;
      }
      
      // Enviar datos a la API para actualizar en MongoDB
      const response = await fetch(`/api/profesores/${profesorId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          ...profesorEditado,
          institucion: institucion // Asegurarse de incluir la institución
        }),
      });
      
      const responseData = await response.json();
      console.log('Respuesta del servidor:', responseData);
      
      if (!response.ok) {
        throw new Error(responseData.message || 'Error al editar profesor');
      }
      
      // Mostrar alerta de éxito
      // Mensaje: Profesor editado correctamente
      
      // Cerrar el modal y limpiar el formulario
      setShowProfesorForm(false);
      setProfesorFormData({
        nombre: '',
        apellido: '',
        cedula: 'N/P',
        email: '',
        telefono: '',
        especialidad: '',
        fechaIngreso: '',
        modoEdicion: false
      });
      
      // Recargar la lista de profesores
      const loadProfesores = async () => {
        try {
          const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
          const response = await fetch(`/api/profesores?creadorId=${userId}`);
          
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.data) {
              const profesoresFormateados = data.data.map(profesor => ({
                _id: profesor._id,
                id: profesor._id,
                cedula: profesor.idU || 'N/P',
                nombre: profesor.nombre || '',
                apellido: profesor.apellido || '',
                email: profesor.email || '',
                telefono: profesor.telefono || '',
                especialidad: profesor.especialidad || '',
                fechaIngreso: profesor.fechaIngreso || null
              }));
              
              setProfesores(profesoresFormateados);
            }
          }
        } catch (error) {
          console.error('Error al recargar profesores:', error);
        }
      };
      
      await loadProfesores();
      setLoading(false);
    } catch (err) {
      console.error('Error al editar profesor:', err);
      setError('Error al editar profesor: ' + (err.message || 'Por favor, intente de nuevo más tarde.'));
      setLoading(false);
      // Mensaje de error: Error al editar profesor
    }
  };

  // Función para eliminar un profesor
  const handleDeleteProfesor = async (profesorId) => {
    // Proceder sin confirmación
    if (true) {
      try {
        setLoading(true);
        console.log('Eliminando profesor con ID:', profesorId);
        
        // Enviar solicitud a la API para eliminar el profesor
        const response = await fetch(`/api/profesores/${profesorId}`, {
          method: 'DELETE',
        });
        
        const responseData = await response.json();
        console.log('Respuesta del servidor:', responseData);
        
        if (!response.ok) {
          throw new Error(responseData.message || 'Error al eliminar profesor');
        }
        
        // Mostrar alerta de éxito
        // Mensaje: Profesor eliminado correctamente
        
        // Recargar la lista de profesores
        const loadProfesores = async () => {
          try {
            const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
            const response = await fetch(`/api/profesores?creadorId=${userId}`);
            
            if (response.ok) {
              const data = await response.json();
              if (data.success && data.data) {
                const profesoresFormateados = data.data.map(profesor => ({
                  _id: profesor._id,
                  id: profesor._id,
                  cedula: profesor.idU || 'N/P',
                  nombre: profesor.nombre || '',
                  apellido: profesor.apellido || '',
                  email: profesor.email || '',
                  telefono: profesor.telefono || '',
                  especialidad: profesor.especialidad || ''
                }));
                
                setProfesores(profesoresFormateados);
              }
            }
          } catch (error) {
            console.error('Error al recargar profesores:', error);
          }
        };
        
        await loadProfesores();
        setLoading(false);
      } catch (err) {
        console.error('Error al eliminar profesor:', err);
        setError('Error al eliminar profesor: ' + (err.message || 'Por favor, intente de nuevo más tarde.'));
        setLoading(false);
        // Mensaje de error: Error al eliminar profesor
      }
    }
  };

  // Funciones para gestionar alumnos
  const handleAddAlumno = async (e) => {
    if (e) e.preventDefault();
    try {
      setLoading(true);
      
      // Verificar si el formulario está disponible antes de intentar acceder a sus valores
      const formSelectors = [
        'input[name="grupo"]',
        'input[name="nombre"]',
        'input[name="apellido"]',
        'input[name="fechaNacimiento"]'
      ];
      
      // Si el usuario es docente, es posible que no tenga acceso al formulario de alumnos
      if (esDocente() && !isFormAvailable(formSelectors)) {
        console.log('Formulario de alumnos no disponible para usuario docente');
        setLoading(false);
        return;
      }
      
      // Obtener todos los valores del formulario de forma segura
      const grupoValue = getFormValue('input[name="grupo"]', '');
      const nombreValue = getFormValue('input[name="nombre"]', '');
      const apellidoValue = getFormValue('input[name="apellido"]', '');
      const fechaNacimientoValue = getFormValue('input[name="fechaNacimiento"]', '');
      const cedulaValue = getFormValue('input[name="cedula"]', 'N/P');
      const lugarNacimientoValue = getFormValue('select[name="lugarNacimiento"]', '');
      const sexoValue = getFormValue('select[name="sexo"]', 'Otro');
      const efValue = getFormValue('input[name="ef"]', '');
      
      console.log('Valores obtenidos directamente del formulario:');
      console.log('Grupo:', grupoValue);
      console.log('Nombre:', nombreValue);
      console.log('Apellido:', apellidoValue);
      console.log('Fecha de nacimiento:', fechaNacimientoValue);
      
      if (!nombreValue || !apellidoValue || !fechaNacimientoValue) {
        setError('Por favor, complete todos los campos requeridos.');
        setLoading(false);
        return;
      }
      
      // Obtener el ID del usuario actual para generar el ID del alumno
      const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
      
      // Obtener el valor de la institución desde el DOM
      const institucionElement = document.getElementById('institucion');
      const institucion = institucionElement ? institucionElement.textContent.trim() : '';
      const userType = sessionStorage.getItem('userType') || localStorage.getItem('userType');
      
      if (!userId) {
        setError('No se pudo identificar al usuario actual. Por favor, inicie sesión nuevamente.');
        setLoading(false);
        return;
      }
      
      // Calcular la edad basada en la fecha de nacimiento
      const fechaNacimiento = new Date(fechaNacimientoValue);
      const hoy = new Date();
      let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
      const mes = hoy.getMonth() - fechaNacimiento.getMonth();
      
      if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNacimiento.getDate())) {
        edad--;
      }
      
      // Determinar si es menor de edad
      const esMenorDeEdad = edad < 18;
      
      // Crear objeto del nuevo alumno con los datos exactos que espera el modelo Estudiante
      const nuevoAlumno = {
        cedula: cedulaValue,
        nombre: nombreValue,
        apellido: apellidoValue,
        fechaNacimiento: fechaNacimientoValue,
        lugarNacimiento: lugarNacimientoValue,
        sexo: sexoValue,
        grupo: grupoValue, // Usar el valor obtenido directamente del DOM
        ef: efValue,
        edad: edad,
        esMenorDeEdad: esMenorDeEdad,
        userId: userId,
        userType: userType,
        institucion: institucion
      };
      
      console.log('Objeto estudiante a enviar:', nuevoAlumno);
      console.log('Valor del grupo a guardar:', nuevoAlumno.grupo);
      
      // Enviar datos a la API para guardar en MongoDB
      const response = await fetch('/api/estudiantes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(nuevoAlumno),
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Error al crear estudiante');
      }
      
      const responseData = await response.json();
      console.log('Respuesta del servidor al crear estudiante:', responseData);
      
      // Limpiar el formulario
      setFormData({
        nombre: '',
        apellido: '',
        cedula: 'N/P',
        fechaNacimiento: '',
        lugarNacimiento: '',
        sexo: 'Otro',
        ef: '',
        grupo: '',
        edad: 0,
        esMenorDeEdad: false,
        modoEdicion: false
      });
      
      // Recargar la lista de estudiantes inmediatamente
      try {
        const response = await fetch(`/api/estudiantes?creadorId=${userId}`);
        
        if (response.ok) {
          const data = await response.json();
          console.log('Datos de estudiantes cargados:', data);
          if (data.success && data.data) {
            const estudiantesFormateados = data.data.map(estudiante => ({
              _id: estudiante._id,
              id: estudiante._id,
              cedula: estudiante.idU || 'N/P',
              nombre: estudiante.nombre || '',
              apellido: estudiante.apellido || '',
              fechaNacimiento: estudiante.fechaNacimiento,
              lugarNacimiento: estudiante.lugarNacimiento || '',
              sexo: estudiante.sexo || 'Otro',
              grupo: estudiante.grupo || '',
              ef: estudiante.ef || '',
              edad: estudiante.edad,
              esMenorDeEdad: estudiante.esMenorDeEdad
            }));
            
            setAlumnos(estudiantesFormateados);
          }
        }
      } catch (error) {
        console.error('Error al recargar estudiantes:', error);
      }
      
      setLoading(false);
      
    } catch (err) {
      console.error('Error al agregar alumno:', err);
      setError('Error al agregar alumno: ' + (err.message || 'Por favor, intente de nuevo más tarde.'));
      setLoading(false);
      // Mensaje de error: Error al agregar alumno
    }
  };

  const handleEditAlumno = async (e) => {
    if (e) e.preventDefault();
    try {
      setLoading(true);
      
      // Verificar si el formulario está disponible antes de intentar acceder a sus valores
      const formSelectors = [
        'input[name="grupo"]',
        'input[name="nombre"]',
        'input[name="apellido"]',
        'input[name="fechaNacimiento"]'
      ];
      
      // Si el usuario es docente, es posible que no tenga acceso al formulario de alumnos
      if (esDocente() && !isFormAvailable(formSelectors)) {
        console.log('Formulario de edición de alumnos no disponible para usuario docente');
        setLoading(false);
        return;
      }
      
      // Obtener todos los valores del formulario de forma segura
      const grupoValue = getFormValue('input[name="grupo"]', '');
      const nombreValue = getFormValue('input[name="nombre"]', '');
      const apellidoValue = getFormValue('input[name="apellido"]', '');
      const fechaNacimientoValue = getFormValue('input[name="fechaNacimiento"]', '');
      const cedulaValue = getFormValue('input[name="cedula"]', 'N/P');
      const lugarNacimientoValue = getFormValue('select[name="lugarNacimiento"]', '');
      const sexoValue = getFormValue('select[name="sexo"]', 'Otro');
      const efValue = getFormValue('input[name="ef"]', '');
      
      console.log('Valores obtenidos directamente del formulario para edición:');
      console.log('Grupo:', grupoValue);
      console.log('Nombre:', nombreValue);
      console.log('Apellido:', apellidoValue);
      console.log('Fecha de nacimiento:', fechaNacimientoValue);
      
      if (!nombreValue || !apellidoValue || !fechaNacimientoValue) {
        setError('Por favor, complete todos los campos requeridos.');
        setLoading(false);
        return;
      }
      
      // Obtener el ID del alumno a editar
      const alumnoId = formData.id || formData._id;
      if (!alumnoId) {
        setError('No se pudo identificar el ID del alumno a editar.');
        setLoading(false);
        return;
      }
      
      // Obtener el valor de la institución desde el DOM
      const institucionElement = document.getElementById('institucion');
      const institucion = institucionElement ? institucionElement.textContent.trim() : '';
      
      // Calcular la edad basada en la fecha de nacimiento
      const fechaNacimiento = new Date(fechaNacimientoValue);
      const hoy = new Date();
      let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
      const mes = hoy.getMonth() - fechaNacimiento.getMonth();
      
      if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNacimiento.getDate())) {
        edad--;
      }
      
      // Determinar si es menor de edad
      const esMenorDeEdad = edad < 18;
      
      // Crear objeto del alumno editado
      const alumnoEditado = {
        nombre: nombreValue,
        apellido: apellidoValue,
        fechaNacimiento: fechaNacimientoValue,
        lugarNacimiento: lugarNacimientoValue,
        sexo: sexoValue,
        grupo: grupoValue, // Usar el valor obtenido directamente del DOM
        ef: efValue,
        edad: edad,
        esMenorDeEdad: esMenorDeEdad
      };
      
      // Solo incluir cédula si no es 'N/P'
      if (cedulaValue && cedulaValue !== 'N/P') {
        alumnoEditado.idU = cedulaValue;
      }
      
      console.log('Objeto estudiante a actualizar:', alumnoEditado);
      console.log('Valor del grupo a actualizar:', alumnoEditado.grupo);
      
      // Enviar datos a la API para actualizar en MongoDB
      const response = await fetch(`/api/estudiantes/${alumnoId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          ...alumnoEditado,
          institucion: institucion,
          userType: sessionStorage.getItem('userType') || localStorage.getItem('userType')
        }),
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Error al editar alumno');
      }
      
      const responseData = await response.json();
      console.log('Respuesta del servidor:', responseData);
      
      // Mostrar alerta de éxito
      // Mensaje: Alumno editado correctamente
      
      // Cerrar el modal y limpiar el formulario
      setShowModal(false);
      setFormData({});
      
      // Recargar la lista de estudiantes
      const loadEstudiantes = async () => {
        try {
          const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
          const response = await fetch(`/api/estudiantes?creadorId=${userId}`);
          
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.data) {
              const estudiantesFormateados = data.data.map(estudiante => ({
                _id: estudiante._id,
                id: estudiante._id,
                cedula: estudiante.idU || 'N/P',
                nombre: estudiante.nombre || '',
                apellido: estudiante.apellido || '',
                fechaNacimiento: estudiante.fechaNacimiento,
                lugarNacimiento: estudiante.lugarNacimiento || '',
                sexo: estudiante.sexo || 'Otro',
                grupo: estudiante.grupo || '',
                ef: estudiante.ef || '',
                edad: estudiante.edad,
                esMenorDeEdad: estudiante.esMenorDeEdad
              }));
              
              setAlumnos(estudiantesFormateados);
            }
          }
        } catch (error) {
          console.error('Error al recargar estudiantes:', error);
        }
      };
      
      await loadEstudiantes();
      setLoading(false);
    } catch (err) {
      console.error('Error al editar alumno:', err);
      setError('Error al editar alumno: ' + (err.message || 'Por favor, intente de nuevo más tarde.'));
      setLoading(false);
      // Mensaje de error: Error al editar alumno
    }
  };

  const handleDeleteAlumno = async (alumnoId) => {
    // Proceder sin confirmación
    if (true) {
      try {
        setLoading(true);
        console.log('Eliminando alumno con ID:', alumnoId);
        
        // Enviar solicitud a la API para eliminar el alumno
        const response = await fetch(`/api/estudiantes/${alumnoId}`, {
          method: 'DELETE',
        });
        
        const responseData = await response.json();
        console.log('Respuesta del servidor:', responseData);
        
        if (!response.ok) {
          throw new Error(responseData.message || 'Error al eliminar alumno');
        }
        
        // Mostrar alerta de éxito
        // Mensaje: Alumno eliminado correctamente
        
        // Recargar la lista de estudiantes
        const loadEstudiantes = async () => {
          try {
            const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
            const response = await fetch(`/api/estudiantes?creadorId=${userId}`);
            
            if (response.ok) {
              const data = await response.json();
              if (data.success && data.data) {
                const estudiantesFormateados = data.data.map(estudiante => ({
                  _id: estudiante._id,
                  id: estudiante._id,
                  cedula: estudiante.idU || 'N/P',
                  nombre: estudiante.nombre || '',
                  fechaNacimiento: estudiante.fechaNacimiento,
                  edad: estudiante.edad,
                  esMenorDeEdad: estudiante.esMenorDeEdad
                }));
                
                setAlumnos(estudiantesFormateados);
              }
            }
          } catch (error) {
            console.error('Error al recargar estudiantes:', error);
          }
        };
        
        await loadEstudiantes();
        setLoading(false);
      } catch (err) {
        console.error('Error al eliminar alumno:', err);
        setError('Error al eliminar alumno: ' + (err.message || 'Por favor, intente de nuevo más tarde.'));
        setLoading(false);
        // Mensaje de error: Error al eliminar alumno
      }
    }
  };
  
  // Función para calcular la edad a partir de la fecha de nacimiento
  const calcularEdad = (fechaNacimiento) => {
    if (!fechaNacimiento) return 0;
    
    const fechaNac = new Date(fechaNacimiento);
    const hoy = new Date();
    let edad = hoy.getFullYear() - fechaNac.getFullYear();
    const mes = hoy.getMonth() - fechaNac.getMonth();
    
    if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate())) {
      edad--;
    }
    
    return edad;
  };
  
  // Función para cambiar el estado de un alumno (0 o 1)
  const handleEstadoChange = async (alumnoId, currentEstado) => {
    try {
      setUpdatingEstado(true);
      const nuevoEstado = currentEstado === 1 ? 0 : 1;
      
      console.log(`Cambiando estado del alumno ${alumnoId} de ${currentEstado} a ${nuevoEstado}`);
      
      // Enviar solicitud a la API para actualizar el estado del alumno
      const response = await fetch(`/api/estudiantes/${alumnoId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          estado: nuevoEstado
        }),
      });
      
      const responseData = await response.json();
      
      if (!response.ok) {
        throw new Error(responseData.message || 'Error al actualizar el estado del alumno');
      }
      
      // Actualizar el estado local de los alumnos
      setAlumnos(alumnos.map(alumno => {
        if ((alumno.id || alumno._id) === alumnoId) {
          return { ...alumno, estado: nuevoEstado };
        }
        return alumno;
      }));
      
      console.log('Estado actualizado correctamente');
    } catch (err) {
      console.error('Error al cambiar el estado del alumno:', err);
      setError('Error al cambiar el estado del alumno: ' + (err.message || 'Por favor, intente de nuevo más tarde.'));
    } finally {
      setUpdatingEstado(false);
    }
  };

  // Funciones para gestionar materias
  const handleMateriaFormChange = (e) => {
    const { name, value } = e.target;
    setMateriaFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  // Función para cargar materias directamente desde MongoDB
  const loadMaterias = async () => {
    try {
      setLoading(true);
      console.log('Cargando materias directamente desde MongoDB...');
      
      // Cargar materias directamente desde la API sin filtros
      const response = await fetch('/api/materias');
      
      if (!response.ok) {
        throw new Error(`Error al cargar materias: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('Materias cargadas desde MongoDB:', data);
      
      if (data.success && data.data) {
        // Verificar la estructura de los datos recibidos
        console.log('Estructura de la primera materia:', JSON.stringify(data.data[0], null, 2));
        
        // Transformar los datos para que coincidan con el formato esperado
        const materiasFormateadas = data.data.map(materia => {
          // Asegurarse de que el _id sea una cadena de texto
          const materiaId = materia._id ? materia._id.toString() : '';
          return {
            _id: materiaId,
            id: materiaId,
            nombre: materia.nombre || 'Sin nombre',
            codigo: materia.codigo || 'N/A',
            descripcion: materia.descripcion || ''
          };
        });
        
        // Imprimir los datos formateados para depuración
        console.log('Materias formateadas con código y descripción:', JSON.stringify(materiasFormateadas, null, 2));
        
        console.log('Materias formateadas para el selector:', materiasFormateadas);
        setMaterias(materiasFormateadas);
      } else {
        console.error('No se recibieron datos de materias válidos');
        setMaterias([]);
      }
      
      setLoading(false);
    } catch (err) {
      console.error('Error al cargar materias:', err);
      setError('Error al cargar materias. Por favor, intente de nuevo más tarde.');
      setLoading(false);
    }
  };
  

  
  // Función para agregar una nueva materia
  const handleAddMateria = async (e) => {
    if (e) e.preventDefault();
    try {
      setLoading(true);
      console.log('Agregando materia con datos:', materiaFormData);
      
      if (!materiaFormData.nombre || !materiaFormData.codigo) {
        // Mensaje: Por favor, complete todos los campos requeridos.
        setError('Por favor, complete todos los campos requeridos.');
        setLoading(false);
        return;
      }
      
      // Obtener el ID del usuario actual
      const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
      
      // Obtener el valor de la institución desde el DOM
      const institucionElement = document.getElementById('institucion');
      const institucion = institucionElement ? institucionElement.textContent.trim() : '';
      console.log('Institución detectada para materia:', institucion);
      const userType = sessionStorage.getItem('userType') || localStorage.getItem('userType');
      
      if (!userId) {
        // Mensaje: No se pudo identificar al usuario actual. Por favor, inicie sesión nuevamente.
        setError('No se pudo identificar al usuario actual. Por favor, inicie sesión nuevamente.');
        setLoading(false);
        return;
      }
      
      // Crear objeto de la nueva materia
      const nuevaMateria = {
        codigo: materiaFormData.codigo,
        nombre: materiaFormData.nombre,
        descripcion: materiaFormData.descripcion || '',
        userId: userId,
        userType: userType,
        institucion: institucion // Incluir el valor de la institución
      };
      
      console.log('Enviando datos al servidor:', nuevaMateria);
      
      // Mostrar alerta para confirmar
      // Proceder sin confirmación
      if (false) {
        setLoading(false);
        return;
      }
      
      // Enviar datos a la API para guardar en MongoDB
      const response = await fetch('/api/materias', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(nuevaMateria),
      });
      
      const responseData = await response.json();
      console.log('Respuesta del servidor:', responseData);
      
      if (!response.ok) {
        throw new Error(responseData.message || 'Error al agregar materia');
      }
      
      // Mostrar alerta de éxito
      // Mensaje: Materia agregada correctamente
      
      // Limpiar el formulario
      setMateriaFormData({
        codigo: '',
        nombre: '',
        descripcion: '',
        modoEdicion: false
      });
      
      // Ocultar el formulario
      setShowMateriaForm(false);
      
      // Recargar la lista de materias
      await loadMaterias();
      
      setLoading(false);
      
    } catch (err) {
      console.error('Error al agregar materia:', err);
      setError('Error al agregar materia: ' + (err.message || 'Por favor, intente de nuevo más tarde.'));
      setLoading(false);
      // Mensaje de error: Error al agregar materia
    }
  };

  const handleEditMateria = async (e) => {
    if (e) e.preventDefault();
    try {
      setLoading(true);
      console.log('Editando materia con datos:', materiaFormData);
      
      if (!materiaFormData.nombre || !materiaFormData.codigo) {
        setError('Por favor, complete todos los campos requeridos.');
        setLoading(false);
        return;
      }
      
      // Obtener el ID de la materia a editar
      const materiaId = materiaFormData.id || materiaFormData._id;
      if (!materiaId) {
        setError('No se pudo identificar el ID de la materia a editar.');
        setLoading(false);
        return;
      }
      
      // Obtener el valor de la institución desde el DOM
      const institucionElement = document.getElementById('institucion');
      const institucion = institucionElement ? institucionElement.textContent.trim() : '';
      console.log('Institución detectada para edición de materia:', institucion);
      
      // Crear objeto de la materia editada
      const materiaEditada = {
        codigo: materiaFormData.codigo,
        nombre: materiaFormData.nombre,
        descripcion: materiaFormData.descripcion || ''
      };
      
      console.log('Enviando datos al servidor para editar:', materiaEditada);
      
      // Mostrar alerta para confirmar
      // Proceder sin confirmación
      if (false) {
        setLoading(false);
        return;
      }
      
      // Enviar datos a la API para actualizar en MongoDB
      const response = await fetch(`/api/materias/${materiaId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          ...materiaEditada,
          institucion: institucion, // Incluir el valor de la institución
          userType: sessionStorage.getItem('userType') || localStorage.getItem('userType')
        }),
      });
      
      const responseData = await response.json();
      console.log('Respuesta del servidor:', responseData);
      
      if (!response.ok) {
        throw new Error(responseData.message || 'Error al editar materia');
      }
      
      // Mostrar alerta de éxito
      // Mensaje: Materia editada correctamente
      
      // Cerrar el modal y limpiar el formulario
      setShowMateriaForm(false);
      setMateriaFormData({
        codigo: '',
        nombre: '',
        descripcion: '',
        modoEdicion: false
      });
      
      // Recargar la lista de materias
      await loadMaterias();
      
      setLoading(false);
    } catch (err) {
      console.error('Error al editar materia:', err);
      setError('Error al editar materia: ' + (err.message || 'Por favor, intente de nuevo más tarde.'));
      setLoading(false);
      // Mensaje de error: Error al editar materia
    }
  };


  const handleDeleteMateria = async (materiaId) => {
    // Proceder sin confirmación
    if (true) {
      try {
        setLoading(true);
        console.log('Eliminando materia con ID:', materiaId);
        
        // Enviar solicitud a la API para eliminar la materia
        const response = await fetch(`/api/materias/${materiaId}`, {
          method: 'DELETE',
        });
        
        const responseData = await response.json();
        console.log('Respuesta del servidor:', responseData);
        
        if (!response.ok) {
          throw new Error(responseData.message || 'Error al eliminar materia');
        }
        
        // Mostrar alerta de éxito
        // Mensaje: Materia eliminada correctamente
        
        // Recargar la lista de materias
        await loadMaterias();
        
        setLoading(false);
      } catch (err) {
        console.error('Error al eliminar materia:', err);
        setError('Error al eliminar materia: ' + (err.message || 'Por favor, intente de nuevo más tarde.'));
        setLoading(false);
        // Mensaje de error: Error al eliminar materia
      }
    }
  };
  
  // Manejar cambios en el formulario de asignación
  const handleAsignacionFormChange = (e) => {
    const { name, value } = e.target;
    setAsignacionFormData({
      ...asignacionFormData,
      [name]: value
    });
  };
  
  // Manejar la selección de alumnos
  const handleAlumnosChange = (selectedAlumnos) => {
    setAsignacionFormData({
      ...asignacionFormData,
      alumnos: selectedAlumnos
    });
  };
  
  // Función para manejar cambios en los campos del formulario de actividades
  const handleActividadFormChange = (e) => {
    const { name, value } = e.target;
    setActividadFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };
  
  // Función para cambiar el profesor de una asignación
  const handleChangeProfesor = async (asignacionId, newProfesorId) => {
    try {
      setLoading(true);
      console.log(`Cambiando profesor de asignación ${asignacionId} a ${newProfesorId}`);
      
      // Si no se seleccionó un profesor, no hacer nada
      if (!newProfesorId) {
        setLoading(false);
        return;
      }
      
      // Buscar el profesor para obtener su nombre
      const profesor = profesores.find(p => p._id === newProfesorId || p.id === newProfesorId);
      if (!profesor) {
        throw new Error(`No se encontró el profesor con ID ${newProfesorId}`);
      }
      
      const profesorNombre = `${profesor.nombre} ${profesor.apellido || ''}`;
      
      // Actualizar la asignación en la base de datos
      const response = await fetch('/api/asignaciones/update-fields', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: asignacionId,
          profesorId: newProfesorId,
          profesorNombre: profesorNombre
        }),
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Error al actualizar profesor: ${errorText}`);
      }
      
      // Actualizar la asignación en el estado local
      setAsignaciones(prevAsignaciones => 
        prevAsignaciones.map(asignacion => {
          if (asignacion._id === asignacionId || asignacion.id === asignacionId) {
            return {
              ...asignacion,
              profesorId: newProfesorId,
              profesorNombre: profesorNombre
            };
          }
          return asignacion;
        })
      );
      
      // Mostrar mensaje de éxito
      toast.success(`Profesor cambiado a ${profesorNombre}`);
      
      setLoading(false);
      setError(null);
    } catch (err) {
      console.error('Error al cambiar profesor:', err);
      setError(`Error al cambiar profesor: ${err.message}`);
      toast.error(`Error al cambiar profesor: ${err.message}`);
      setLoading(false);
    }
  };
  
  // Función para cambiar el profesor de una asignación
  const handleChangeProfesor = async (asignacionId, newProfesorId) => {
    try {
      setLoading(true);
      console.log(`Cambiando profesor de asignación ${asignacionId} a ${newProfesorId}`);
      
      // Si no se seleccionó un profesor, no hacer nada
      if (!newProfesorId) {
        setLoading(false);
        return;
      }
      
      // Buscar el profesor para obtener su nombre
      const profesor = profesores.find(p => p._id === newProfesorId || p.id === newProfesorId);
      if (!profesor) {
        throw new Error(`No se encontró el profesor con ID ${newProfesorId}`);
      }
      
      const profesorNombre = `${profesor.nombre} ${profesor.apellido || ''}`;
      
      // Actualizar la asignación en la base de datos
      const response = await fetch('/api/asignaciones/update-fields', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: asignacionId,
          profesorId: newProfesorId,
          profesorNombre: profesorNombre
        }),
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Error al actualizar profesor: ${errorText}`);
      }
      
      // Actualizar la asignación en el estado local
      setAsignaciones(prevAsignaciones => 
        prevAsignaciones.map(asignacion => {
          if (asignacion._id === asignacionId || asignacion.id === asignacionId) {
            return {
              ...asignacion,
              profesorId: newProfesorId,
              profesorNombre: profesorNombre
            };
          }
          return asignacion;
        })
      );
      
      // Mostrar mensaje de éxito
      toast.success(`Profesor cambiado a ${profesorNombre}`);
      
      setLoading(false);
      setError(null);
    } catch (err) {
      console.error('Error al cambiar profesor:', err);
      setError(`Error al cambiar profesor: ${err.message}`);
      toast.error(`Error al cambiar profesor: ${err.message}`);
      setLoading(false);
    }
  };
  
  // Función para cambiar el profesor de una asignación
  const handleChangeProfesor = async (asignacionId, newProfesorId) => {
    try {
      setLoading(true);
      console.log(`Cambiando profesor de asignación ${asignacionId} a ${newProfesorId}`);
      
      // Si no se seleccionó un profesor, no hacer nada
      if (!newProfesorId) {
        setLoading(false);
        return;
      }
      
      // Buscar el profesor para obtener su nombre
      const profesor = profesores.find(p => p._id === newProfesorId || p.id === newProfesorId);
      if (!profesor) {
        throw new Error(`No se encontró el profesor con ID ${newProfesorId}`);
      }
      
      const profesorNombre = `${profesor.nombre} ${profesor.apellido || ''}`;
      
      // Actualizar la asignación en la base de datos
      const response = await fetch('/api/asignaciones/update-fields', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: asignacionId,
          profesorId: newProfesorId,
          profesorNombre: profesorNombre
        }),
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Error al actualizar profesor: ${errorText}`);
      }
      
      // Actualizar la asignación en el estado local
      setAsignaciones(prevAsignaciones => 
        prevAsignaciones.map(asignacion => {
          if (asignacion._id === asignacionId || asignacion.id === asignacionId) {
            return {
              ...asignacion,
              profesorId: newProfesorId,
              profesorNombre: profesorNombre
            };
          }
          return asignacion;
        })
      );
      
      setLoading(false);
      setError(null);
    } catch (err) {
      console.error('Error al cambiar profesor:', err);
      setError(`Error al cambiar profesor: ${err.message}`);
      setLoading(false);
    }
  };
  
  // Función para cargar asignaciones con datos completos desde MongoDB
  const loadAsignaciones = async () => {
    try {
      setLoading(true);
      console.log('Cargando asignaciones con datos completos...');
      
      // Cargar asignaciones desde la API
      const response = await fetch('/api/asignaciones');
      
      if (!response.ok) {
        throw new Error(`Error al cargar asignaciones: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('Asignaciones cargadas:', data);
      
      // Determinar la estructura de los datos recibidos
      let asignacionesData = [];
      if (Array.isArray(data)) {
        asignacionesData = data;
      } else if (data && data.success && Array.isArray(data.data)) {
        asignacionesData = data.data;
      } else {
        console.error('Los datos recibidos no tienen el formato esperado:', data);
        setAsignaciones([]);
        setLoading(false);
        return;
      }
      
      // Para cada asignación, vamos a cargar los datos completos de materia, profesor y alumnos
      const asignacionesCompletas = await Promise.all(asignacionesData.map(async (asignacion) => {
        let asignacionCompleta = { ...asignacion };
        
        // Si no tiene materiaNombre, cargar datos de la materia
        if (!asignacion.materiaNombre && asignacion.materiaId) {
          try {
            const materiaResponse = await fetch(`/api/materias/${asignacion.materiaId}`);
            if (materiaResponse.ok) {
              const materiaData = await materiaResponse.json();
              if (materiaData.success && materiaData.data) {
                const materia = materiaData.data;
                asignacionCompleta.materiaNombre = `${materia.codigo || 'N/A'} - ${materia.nombre || 'Sin nombre'}`;
              }
            }
          } catch (error) {
            console.error('Error al cargar datos de materia:', error);
          }
        }
        
        // Si no tiene profesorNombre, cargar datos del profesor
        if (!asignacion.profesorNombre && asignacion.profesorId) {
          try {
            const profesorResponse = await fetch(`/api/profesores/${asignacion.profesorId}`);
            if (profesorResponse.ok) {
              const profesorData = await profesorResponse.json();
              if (profesorData.success && profesorData.data) {
                const profesor = profesorData.data;
                asignacionCompleta.profesorNombre = `${profesor.nombre || ''} ${profesor.apellido || ''}`;
              }
            }
          } catch (error) {
            console.error('Error al cargar datos de profesor:', error);
          }
        }
        
        // Si no tiene alumnosInfo, cargar datos de los alumnos
        if ((!asignacion.alumnosInfo || asignacion.alumnosInfo.length === 0) && asignacion.alumnos && asignacion.alumnos.length > 0) {
          try {
            // Crear un array para almacenar la información de los alumnos
            const alumnosInfo = [];
            
            // Primero, obtener todos los estudiantes para buscar por nombre
            try {
              console.log('Obteniendo lista completa de estudiantes');
              const estudiantesResponse = await fetch('/api/estudiantes');
              
              if (estudiantesResponse.ok) {
                const estudiantesData = await estudiantesResponse.json();
                console.log('Datos de estudiantes recibidos:', estudiantesData);
                
                if (estudiantesData.success && Array.isArray(estudiantesData.data)) {
                  const todosEstudiantes = estudiantesData.data;
                  
                  // Para cada ID de alumno en la asignación
                  for (const alumnoId of asignacion.alumnos) {
                    try {
                      // Buscar el estudiante por ID
                      const estudiante = todosEstudiantes.find(est => est._id === alumnoId);
                      
                      if (estudiante) {
                        console.log(`Estudiante encontrado para ID ${alumnoId}:`, estudiante);
                        
                        // Obtener nombre e identificación
                        const nombre = estudiante.nombre || 'Sin nombre';
                        const apellido = estudiante.apellido || '';
                        const identificacion = estudiante.idU || estudiante.cedula || 'N/A';
                        
                        console.log(`Datos del estudiante completos:`, estudiante);
                        console.log(`Nombre: ${nombre}, Apellido: ${apellido}, Identificación: ${identificacion}`);
                        
                        alumnosInfo.push({
                          id: estudiante._id,
                          nombre: nombre,
                          apellido: estudiante.apellido || '',
                          cedula: identificacion,
                          idU: estudiante.idU || 'N/P' // Asegurar que se incluya la identificación
                        });
                      } else {
                        console.log(`No se encontró estudiante para ID ${alumnoId}, intentando obtener por API individual`);
                        
                        // Si no se encuentra en la lista completa, intentar obtener individualmente
                        const alumnoResponse = await fetch(`/api/estudiantes/${alumnoId}`);
                        if (alumnoResponse.ok) {
                          const alumnoData = await alumnoResponse.json();
                          
                          if (alumnoData.success && alumnoData.data) {
                            const alumno = alumnoData.data;
                            alumnosInfo.push({
                              id: alumno._id,
                              nombre: alumno.nombre || 'Sin nombre',
                              apellido: alumno.apellido || '',
                              cedula: alumno.idU || alumno.cedula || 'N/A',
                              idU: alumno.idU || 'N/P'
                            });
                          }
                        }
                      }
                    } catch (error) {
                      console.error(`Error al procesar alumno con ID ${alumnoId}:`, error);
                    }
                  }
                }
              } else {
                console.error('Error al obtener lista de estudiantes:', await estudiantesResponse.text());
                
                // Método de respaldo: obtener estudiantes uno por uno
                for (const alumnoId of asignacion.alumnos) {
                  try {
                    const alumnoResponse = await fetch(`/api/estudiantes/${alumnoId}`);
                    if (alumnoResponse.ok) {
                      const alumnoData = await alumnoResponse.json();
                      
                      if (alumnoData.success && alumnoData.data) {
                        const alumno = alumnoData.data;
                        alumnosInfo.push({
                          id: alumno._id,
                          nombre: alumno.nombre || 'Sin nombre',
                          apellido: alumno.apellido || '',
                          cedula: alumno.idU || alumno.cedula || 'N/A',
                          idU: alumno.idU || 'N/P'
                        });
                      }
                    }
                  } catch (error) {
                    console.error(`Error al procesar alumno con ID ${alumnoId}:`, error);
                  }
                }
              }
            } catch (error) {
              console.error('Error al obtener estudiantes:', error);
            }
            
            asignacionCompleta.alumnosInfo = alumnosInfo;
          } catch (error) {
            console.error('Error al cargar datos de alumnos:', error);
          }
        }
        
        return asignacionCompleta;
      }));
      
      console.log('Asignaciones con datos completos:', asignacionesCompletas);
      setAsignaciones(asignacionesCompletas);
      setLoading(false);
    } catch (err) {
      console.error('Error al cargar asignaciones:', err);
      setError('Error al cargar asignaciones. Por favor, intente de nuevo más tarde.');
      setAsignaciones([]);
      setLoading(false);
    }
  };
  const handleAddAsignacion = async (e) => {
    if (e) e.preventDefault();
    try {
      setLoading(true);
      console.log('Agregando asignaciones para el año:', asignacionFormData.anio);
      
      if (!asignacionFormData.profesorId) {
        // Mensaje: Por favor, seleccione un profesor.
        setError('Por favor, seleccione un profesor.');
        setLoading(false);
        return;
      }
      
      // Obtener el ID del usuario actual
      const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
      const userType = sessionStorage.getItem('userType') || localStorage.getItem('userType');
      
      if (!userId) {
        // Mensaje: No se pudo identificar al usuario actual. Por favor, inicie sesión nuevamente.
        setError('No se pudo identificar al usuario actual. Por favor, inicie sesión nuevamente.');
        setLoading(false);
        return;
      }
      
      // Definir las materias para cada año según el plan de estudio
      const materiasPorAnio = {
        '1 año': [
          { nombre: 'Inglés y otras Lenguas Extranjeras', codigo: 'ILE-1', letras: 'CATOLIC' },
          { nombre: 'Matemáticas', codigo: 'MA-1', letras: 'DECIMO' },
          { nombre: 'Educación Física', codigo: 'EF-1', letras: 'NOTABL' },
          { nombre: 'Arte y Patrimonio', codigo: 'AP-1', letras: 'DECENTE' },
          { nombre: 'Ciencias Naturales', codigo: 'CN-1', letras: 'DEODIO' },
          { nombre: 'Geografía, Historia y Ciudadanía', codigo: 'GHC-1', letras: 'DECENTE' }
        ],
        '2 año': [
          { nombre: 'Inglés y otras Lenguas Extranjeras', codigo: 'ILE-2', letras: 'DEODIO' },
          { nombre: 'Matemáticas', codigo: 'MA-2', letras: 'DECENTE' },
          { nombre: 'Educación Física', codigo: 'EF-2', letras: 'DECENTE' },
          { nombre: 'Arte y Patrimonio', codigo: 'AP-2', letras: 'VENTE' },
          { nombre: 'Ciencias Naturales', codigo: 'CN-2', letras: 'DIECIEVE' },
          { nombre: 'Geografía, Historia y Ciudadanía', codigo: 'GHC-2', letras: 'VENTE' }
        ],
        '3 año': [
          { nombre: 'Castellano', codigo: 'CAS-3', letras: 'DEODIO' },
          { nombre: 'Inglés y otras Lenguas Extranjeras', codigo: 'ILE-3', letras: 'DECENTE' },
          { nombre: 'Matemáticas', codigo: 'MA-3', letras: 'DEODIO' },
          { nombre: 'Educación Física', codigo: 'EF-3', letras: 'DEODIO' },
          { nombre: 'Física', codigo: 'FIS-3', letras: 'DECENTE' },
          { nombre: 'Química', codigo: 'QUI-3', letras: 'DEODIO' },
          { nombre: 'Biología', codigo: 'BIO-3', letras: 'DEODIO' },
          { nombre: 'Geografía, Historia y Ciudadanía', codigo: 'GHC-3', letras: 'VENTE' }
        ],
        '4 año': [
          { nombre: 'Castellano', codigo: 'CAS-4', letras: 'DECENTE' },
          { nombre: 'Inglés y otras Lenguas Extranjeras', codigo: 'ILE-4', letras: 'DECENTE' },
          { nombre: 'Matemáticas', codigo: 'MA-4', letras: 'DECENTE' },
          { nombre: 'Educación Física', codigo: 'EF-4', letras: 'DECENTE' },
          { nombre: 'Física', codigo: 'FIS-4', letras: 'DECENTE' },
          { nombre: 'Química', codigo: 'QUI-4', letras: 'DEODIO' },
          { nombre: 'Biología', codigo: 'BIO-4', letras: 'DEODIO' },
          { nombre: 'Geografía, Historia y Ciudadanía', codigo: 'GHC-4', letras: 'DECENTE' },
          { nombre: 'Formación para la Soberanía Nacional', codigo: 'FSN-4', letras: 'DIECIEVE' }
        ],
        '5 año': [
          { nombre: 'Castellano', codigo: 'CAS-5', letras: 'NOTABL' },
          { nombre: 'Inglés y otras Lenguas Extranjeras', codigo: 'ILE-5', letras: 'REGU' },
          { nombre: 'Matemáticas', codigo: 'MA-5', letras: 'QUINCE' },
          { nombre: 'Educación Física', codigo: 'EF-5', letras: 'QUINCE' },
          { nombre: 'Física', codigo: 'FIS-5', letras: 'CATORC' },
          { nombre: 'Química', codigo: 'QUI-5', letras: 'TRECE' },
          { nombre: 'Ciencias de la Tierra', codigo: 'CDT-5', letras: 'CATORC' },
          { nombre: 'Geografía, Historia y Ciudadanía', codigo: 'GHC-5', letras: 'DOCE' },
          { nombre: 'Formación para la Soberanía Nacional', codigo: 'FSN-5', letras: 'TRECE' }
        ]
      };
      
      // Añadir las áreas de formación complementarias para 5to año
      const areasComplementarias = [
        { nombre: 'Orientación y Convivencia', grupo: '1', literal: 'A' },
        { nombre: 'Grupo Estable', grupo: '2', literal: 'A' },
        { nombre: 'Pasantía', grupo: '3', literal: 'A' },
        { nombre: 'Proyecto Productivo', grupo: '4', literal: 'A' },
        { nombre: 'Acto Cívico', grupo: '5', literal: 'A' }
      ];
      
      // Añadir las áreas complementarias a 5to año
      if (asignacionFormData.anio === '5 año') {
        materiasPorAnio['5 año'] = [...materiasPorAnio['5 año'], ...areasComplementarias];
      }
      
      // Obtener las materias del año seleccionado
      const materiasDelAnio = materiasPorAnio[asignacionFormData.anio] || [];
      
      if (materiasDelAnio.length === 0) {
        setError(`No se encontraron materias para ${asignacionFormData.anio}. Por favor, seleccione un año válido.`);
        setLoading(false);
        return;
      }
      
      const profesor = profesores.find(p => p.id === asignacionFormData.profesorId || p._id === asignacionFormData.profesorId);
      
      // Asegurar que los IDs de alumnos sean strings
      let alumnosArray = [];
      if (asignacionFormData.alumnos && asignacionFormData.alumnos.length > 0) {
        alumnosArray = asignacionFormData.alumnos.map(alumnoId => {
          // Convertir a string si es un objeto
          if (typeof alumnoId === 'object' && alumnoId !== null) {
            return alumnoId._id?.toString() || alumnoId.id?.toString() || '';
          }
          return alumnoId.toString();
        }).filter(id => id); // Eliminar IDs vacíos
      }
      
      // Preparar la información de alumnosInfo basada en los alumnos seleccionados
      let alumnosInfoArray = [];
      if (alumnosArray.length > 0) {
        alumnosInfoArray = alumnosArray.map(alumnoId => {
          const alumno = alumnos.find(a => (a._id === alumnoId || a.id === alumnoId));
          return alumno ? {
            id: alumno._id || alumno.id,
            nombre: `${alumno.nombre} ${alumno.apellido}` || 'Sin nombre',
            idU: alumno.idU || 'N/P',
            cedula: alumno.idU || alumno.cedula || 'N/A'
          } : null;
        }).filter(info => info !== null); // Eliminar entradas nulas
      }
      
      console.log('Alumnos procesados para crear asignaciones:', alumnosArray);
      console.log('AlumnosInfo procesado para crear asignaciones:', alumnosInfoArray);
      
      // Crear asignaciones para cada materia del año seleccionado
      const asignacionesCreadas = [];
      const profesorNombre = profesor ? `${profesor.nombre} ${profesor.apellido || ''}` : 'Profesor sin nombre';
      
      // Procesar las materias en secuencia para evitar problemas de concurrencia
      for (const materia of materiasDelAnio) {
        try {
          console.log(`Procesando materia: ${materia.nombre}`);
          
          // Primero, verificar si la materia ya existe en la base de datos o crearla
          console.log(`Buscando o creando materia: ${materia.nombre}`);
          
          // Intentar buscar la materia por código
          const searchResponse = await fetch(`/api/materias?codigo=${encodeURIComponent(materia.codigo)}`);
          const searchData = await searchResponse.json();
          let materiaId;
          
          if (searchData.success && searchData.data && searchData.data.length > 0) {
            // Si la materia existe, usar su ID
            materiaId = searchData.data[0]._id;
            console.log(`Materia encontrada en la base de datos: ${materia.nombre} (${materiaId})`);
          } else {
            // Si no existe, crearla
            console.log(`Creando nueva materia: ${materia.nombre}`);
            const nuevaMateria = {
              codigo: materia.codigo,
              nombre: materia.nombre,
              descripcion: `Materia de ${asignacionFormData.anio}`,
              userId: userId,
              userType: userType,
              institucion: 'Acacias' // Valor por defecto
            };
            
            const createResponse = await fetch('/api/materias', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(nuevaMateria),
            });
            
            const createData = await createResponse.json();
            
            if (createResponse.ok && createData.success) {
              materiaId = createData.data._id;
              console.log(`Nueva materia creada con ID: ${materiaId}`);
            } else {
              console.error(`Error al crear materia ${materia.nombre}:`, createData.message);
              continue; // Pasar a la siguiente materia
            }
          }
          
          // Crear objeto con datos básicos para la API normal
          const nuevaAsignacion = {
            materiaId: materiaId,  // Usar el ID de la materia existente
            profesorId: asignacionFormData.profesorId,
            alumnos: alumnosArray,
            periodo: asignacionFormData.periodo || '',
            anio: asignacionFormData.anio || '1 año',
            userId: userId,
            userType: userType
          };
          
          console.log(`Enviando datos para crear asignación de ${materia.nombre}:`, JSON.stringify(nuevaAsignacion, null, 2));
          
          // Enviar datos a la API para guardar en MongoDB
          const response = await fetch('/api/asignaciones', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(nuevaAsignacion),
          });
          
          const responseData = await response.json();
          console.log(`Respuesta del servidor para ${materia.nombre}:`, responseData);
          
          if (!response.ok) {
            console.error(`Error al crear asignación para ${materia.nombre}:`, responseData.message);
            continue; // Continuar con la siguiente materia si hay error
          }
          
          // Obtener el ID de la asignación recién creada
          const asignacionId = responseData.data?._id || responseData.data?.id;
          
          if (asignacionId) {
            // Actualizar los campos adicionales usando la API directa
            const datosAdicionales = {
              id: asignacionId,
              materiaNombre: `${materia.codigo} - ${materia.nombre}`,
              profesorNombre: profesorNombre,
              periodo: asignacionFormData.periodo || '',
              alumnosInfo: alumnosInfoArray
            };
            
            console.log(`Enviando datos adicionales para ${materia.nombre}:`, JSON.stringify(datosAdicionales, null, 2));
            
            const responseAdicional = await fetch('/api/asignaciones/update-fields', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(datosAdicionales),
            });
            
            const responseDataAdicional = await responseAdicional.json();
            
            if (responseAdicional.ok) {
              asignacionesCreadas.push(materia.nombre);
            } else {
              console.warn(`Advertencia: No se pudieron actualizar campos adicionales para ${materia.nombre}`);
            }
          }
        } catch (error) {
          console.error(`Error al procesar la materia ${materia.nombre}:`, error);
          // Continuar con la siguiente materia si hay error
        }
      }
      
      // Mostrar alerta de éxito
      // Mensaje: Asignación creada correctamente
      
      // Limpiar el formulario
      setAsignacionFormData({
        materiaId: '',
        profesorId: '',
        alumnos: [],
        modoEdicion: false
      });
      
      // Ocultar el formulario
      setShowAsignacionForm(false);
      
      // Recargar la lista de asignaciones
      await loadAsignaciones();
      
      setLoading(false);
      
    } catch (err) {
      console.error('Error al crear asignación:', err);
      setError('Error al crear asignación: ' + (err.message || 'Por favor, intente de nuevo más tarde.'));
      setLoading(false);
      // Mensaje de error: Error al crear asignación
    }
  };
  
  // Función para agregar una actividad a una asignación
  const handleAddActividad = async (e) => {
    if (e) e.preventDefault();
    try {
      setLoading(true);
      console.log('Agregando actividad con datos:', actividadFormData);
      
      if (!actividadFormData.nombre || !actividadFormData.fecha || !actividadFormData.porcentaje) {
        // Mensaje: Por favor, complete todos los campos obligatorios.
        setError('Por favor, complete todos los campos obligatorios.');
        setLoading(false);
        return;
      }
      
      // Validar que la asignación seleccionada exista
      if (!modalData || (!modalData.id && !modalData._id)) {
        // Mensaje: No se pudo identificar la asignación a la que agregar la actividad.
        setError('No se pudo identificar la asignación a la que agregar la actividad.');
        setLoading(false);
        return;
      }
      
      // Crear objeto de la nueva actividad
      const nuevaActividad = {
        nombre: actividadFormData.nombre,
        descripcion: actividadFormData.descripcion || '',
        fecha: actividadFormData.fecha,
        porcentaje: parseInt(actividadFormData.porcentaje, 10)
      };
      
      console.log('Enviando datos al servidor:', nuevaActividad);
      
      // Mostrar alerta para confirmar
      // Proceder sin confirmación
      if (false) {
        setLoading(false);
        return;
      }
      
      // Enviar datos a la API para guardar en MongoDB
      const asignacionId = modalData.id || modalData._id;
      const response = await fetch(`/api/asignaciones/${asignacionId}/actividades`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(nuevaActividad),
      });
      
      const responseData = await response.json();
      console.log('Respuesta del servidor:', responseData);
      
      if (!response.ok) {
        throw new Error(responseData.message || 'Error al agregar actividad');
      }
      
      // Mostrar alerta de éxito
      // Mensaje: Actividad agregada correctamente
      
      // Limpiar el formulario
      setActividadFormData({
        nombre: '',
        descripcion: '',
        fecha: new Date().toISOString().split('T')[0],
        porcentaje: 0
      });
      
      // Cerrar el modal
      setShowModal(false);
      
      // Recargar la lista de asignaciones para ver la nueva actividad
      await loadAsignaciones();
      
      setLoading(false);
    } catch (err) {
      console.error('Error al agregar actividad:', err);
      setError('Error al agregar actividad: ' + (err.message || 'Por favor, intente de nuevo más tarde.'));
      setLoading(false);
      // Mensaje de error: Error al agregar actividad
    }
  };
  
  // Función para eliminar una asignación
  const handleDeleteAsignacion = async (asignacionId) => {
    try {
      // Proceder sin confirmación
      // Anteriormente se usaba window.confirm para confirmar la eliminación
      // Ahora se procede directamente con la eliminación sin mostrar un alert
      
      setLoading(true);
      // Llamar a la API para eliminar la asignación
      const response = await fetch(`/api/asignaciones/${asignacionId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
      });
      
      const responseData = await response.json();
      console.log('Respuesta del servidor:', responseData);
      
      if (!response.ok) {
        throw new Error(responseData.message || 'Error al eliminar asignación');
      }
      
      // Mostrar alerta de éxito
      // Mensaje: Asignación eliminada correctamente
      
      // Si la asignación eliminada es la seleccionada, limpiar la selección
      if (asignacionSeleccionada && (asignacionSeleccionada._id === asignacionId || asignacionSeleccionada.id === asignacionId)) {
        setAsignacionSeleccionada(null);
      }
      
      // Recargar la lista de asignaciones
      await loadAsignaciones();
      
      setLoading(false);
    } catch (err) {
      console.error('Error al eliminar asignación:', err);
      setError('Error al eliminar asignación: ' + (err.message || 'Por favor, intente de nuevo más tarde.'));
      setLoading(false);
      // Mensaje de error: Error al eliminar asignación
    }
  };

  // Funciones para gestionar asignaciones y actividades ya implementadas arriba
  const handleEditAsignacion = async (e) => {
    if (e) e.preventDefault();
    try {
      setLoading(true);
      console.log('Editando asignación con datos:', asignacionFormData);
      
      if (!asignacionFormData.materiaId || !asignacionFormData.profesorId) {
        // Mensaje: Por favor, seleccione una materia y un profesor.
        setError('Por favor, seleccione una materia y un profesor.');
        setLoading(false);
        return;
      }
      
      // Obtener el ID de la asignación a editar
      const asignacionId = asignacionFormData.id;
      if (!asignacionId) {
        setError('No se pudo identificar el ID de la asignación a editar.');
        setLoading(false);
        return;
      }
      
      // Obtener la materia y el profesor para incluir sus nombres
      const materia = materias.find(m => m.id === asignacionFormData.materiaId || m._id === asignacionFormData.materiaId);
      const profesor = profesores.find(p => p.id === asignacionFormData.profesorId || p._id === asignacionFormData.profesorId);
      
      // Asegurar que los IDs de alumnos sean strings
      let alumnosArray = [];
      if (asignacionFormData.alumnos && asignacionFormData.alumnos.length > 0) {
        alumnosArray = asignacionFormData.alumnos.map(alumnoId => {
          // Convertir a string si es un objeto
          if (typeof alumnoId === 'object' && alumnoId !== null) {
            return alumnoId._id?.toString() || alumnoId.id?.toString() || '';
          }
          return alumnoId.toString();
        }).filter(id => id); // Eliminar IDs vacíos
      }
      
      console.log('Alumnos procesados para editar asignación:', alumnosArray);
      
      // Preparar la información de alumnosInfo basada en los alumnos seleccionados actualmente
      let alumnosInfoArray = [];
      if (alumnosArray.length > 0) {
        alumnosInfoArray = alumnosArray.map(alumnoId => {
          const alumno = alumnos.find(a => (a._id === alumnoId || a.id === alumnoId));
          return alumno ? {
            id: alumno._id || alumno.id,
            nombre: alumno.nombre || 'Sin nombre',
            idU: alumno.idU || 'N/P',
            cedula: alumno.idU || alumno.cedula || 'N/A'
          } : null;
        }).filter(info => info !== null); // Eliminar entradas nulas
      }
      
      console.log('AlumnosInfo procesado para editar asignación:', alumnosInfoArray);
      
      // Crear objeto de la asignación editada con todos los campos necesarios
      const asignacionEditada = {
        materiaId: asignacionFormData.materiaId,
        profesorId: asignacionFormData.profesorId,
        periodo: asignacionFormData.periodo || '',
        alumnos: alumnosArray
      };
      
      console.log('Enviando datos al servidor para editar:', JSON.stringify(asignacionEditada, null, 2));
      
      // Paso 1: Actualizar los campos básicos usando la API normal
      const response = await fetch(`/api/asignaciones/${asignacionId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(asignacionEditada),
      });
      
      const responseData = await response.json();
      console.log('Respuesta del servidor (paso 1):', responseData);
      
      if (!response.ok) {
        throw new Error(responseData.message || 'Error al editar asignación');
      }
      
      // Paso 2: Actualizar los campos adicionales usando la API directa
      const materiaNombre = materia ? `${materia.codigo || ''} - ${materia.nombre}` : 'Materia sin nombre';
      const profesorNombre = profesor ? `${profesor.nombre} ${profesor.apellido || ''}` : 'Profesor sin nombre';
      
      const datosAdicionales = {
        id: asignacionId,
        materiaNombre: materiaNombre,
        profesorNombre: profesorNombre,
        periodo: asignacionFormData.periodo || '',
        alumnosInfo: alumnosInfoArray
      };
      
      console.log('Enviando datos adicionales para actualizar:', JSON.stringify(datosAdicionales, null, 2));
      
      const responseAdicional = await fetch('/api/asignaciones/update-fields', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(datosAdicionales),
      });
      
      const responseDataAdicional = await responseAdicional.json();
      console.log('Respuesta del servidor (paso 2):', responseDataAdicional);
      
      if (!responseAdicional.ok) {
        console.warn('Advertencia: No se pudieron actualizar algunos campos adicionales');
      }
      
      // Mostrar alerta de éxito
      // Mensaje: Asignación editada correctamente
      
      // Limpiar el formulario y ocultar
      setAsignacionFormData({
        materiaId: '',
        profesorId: '',
        alumnos: [],
        modoEdicion: false
      });
      
      // Ocultar el formulario
      setShowAsignacionForm(false);
      
      // Recargar la lista de asignaciones
      await loadAsignaciones();
      
      setLoading(false);
    } catch (err) {
      console.error('Error al editar asignación:', err);
      setError('Error al editar asignación: ' + (err.message || 'Por favor, intente de nuevo más tarde.'));
      setLoading(false);
      // Mensaje de error: Error al editar asignación
    }
  };

  const handleSaveCalificaciones = async (asignacionId, actividadId, calificaciones) => {
    try {
      setLoading(true);
      // Aquí iría la lógica para guardar las calificaciones en la base de datos
      // Por ahora, simularemos la actualización
      const nuevasAsignaciones = asignaciones.map(asig => {
        if (asig.id === asignacionId) {
          const nuevasActividades = asig.actividades.map(act => {
            if (act.id === actividadId) {
              return {
                ...act,
                calificaciones
              };
            }
            return act;
          });
          
          return {
            ...asig,
            actividades: nuevasActividades
          };
        }
        return asig;
      });
      
      setAsignaciones(nuevasAsignaciones);
      setShowModal(false);
      setFormData({});
      setLoading(false);
    } catch (err) {
      console.error('Error al guardar calificaciones:', err);
      setError('Error al guardar calificaciones. Por favor, intente de nuevo más tarde.');
      setLoading(false);
    }
  };

  // Función para generar reporte de notas
  const generateReporte = (asignacionId) => {
    const asignacion = asignaciones.find(a => a.id === asignacionId);
    if (!asignacion) return [];
    
    const materia = materias.find(m => m.id === asignacion.materiaId);
    const docente = docentes.find(d => d.id === asignacion.docenteId);
    
    return asignacion.alumnos.map(alumnoId => {
      const alumno = alumnos.find(a => a.id === alumnoId);
      if (!alumno) return null;
      
      // Calcular notas y promedio
      const notasAlumno = asignacion.actividades.map(act => {
        const calificacion = act.calificaciones.find(c => c.alumnoId === alumnoId);
        return {
          actividad: act.nombre,
          nota: calificacion ? calificacion.nota : 0
        };
      });
      
      const sumaNotas = notasAlumno.reduce((sum, item) => sum + item.nota, 0);
      const promedio = notasAlumno.length > 0 ? sumaNotas / notasAlumno.length : 0;
      
      return {
        alumno,
        materia,
        docente,
        notas: notasAlumno,
        promedio: parseFloat(promedio.toFixed(2))
      };
    }).filter(Boolean);
  };

  // Mapeo de estados a códigos
  const estadosCodigos = {
    "Amazonas": "AM",
    "Anzoátegui": "AN",
    "Apure": "AP",
    "Aragua": "AR",
    "Barinas": "BA",
    "Bolívar": "BO",
    "Carabobo": "CA",
    "Cojedes": "CO",
    "Delta Amacuro": "DA",
    "Distrito Capital": "DC",
    "Falcón": "FA",
    "Guárico": "GU",
    "Lara": "LA",
    "Mérida": "ME",
    "Miranda": "MI",
    "Monagas": "MO",
    "Nueva Esparta": "NE",
    "Portuguesa": "PO",
    "Sucre": "SU",
    "Táchira": "TA",
    "Trujillo": "TR",
    "Vargas": "VA",
    "Yaracuy": "YA",
    "Zulia": "ZU",
    "La Guaira": "LG",
    "Dependencias Federales": "DF",
    "Territorio Esequibo": "TE"
  };

  // Función para manejar cambios en el formulario
  const handleFormChange = (e) => {
    const { name, value } = e.target;
    console.log(`Campo cambiado: ${name}, valor: ${value}`);
    
    // Si se cambia el lugar de nacimiento, actualizar automáticamente el campo ef con el código del estado
    if (name === 'lugarNacimiento' && value) {
      const codigoEstado = estadosCodigos[value] || '';
      setFormData({
        ...formData,
        [name]: value,
        ef: codigoEstado
      });
      console.log('Actualizando lugarNacimiento y ef:', { ...formData, [name]: value, ef: codigoEstado });
    }
    // Si se cambia la fecha de nacimiento, calcular la edad
    else if (name === 'fechaNacimiento' && value) {
      const fechaNacimiento = new Date(value);
      const hoy = new Date();
      let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
      const mes = hoy.getMonth() - fechaNacimiento.getMonth();
      
      if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNacimiento.getDate())) {
        edad--;
      }
      
      setFormData({
        ...formData,
        [name]: value,
        edad: edad,
        esMenorDeEdad: edad < 18
      });
      console.log('Actualizando fechaNacimiento y edad:', { ...formData, [name]: value, edad, esMenorDeEdad: edad < 18 });
    }
    // Si se cambia el grupo, registrar específicamente y usar asignación directa
    else if (name === 'grupo') {
      setFormData({
        ...formData,
        grupo: value // Usar el nombre directo en lugar de la notación computada para asegurar que se guarde correctamente
      });
      console.log('Actualizando grupo:', { ...formData, grupo: value });
    }
    // Para cualquier otro campo, actualizar normalmente
    else {
      setFormData({
        ...formData,
        [name]: value
      });
      console.log('Actualizando campo general:', { ...formData, [name]: value });
    }
  };

  // Función para abrir modal
  const openModal = (type, data = null) => {
    setModalType(type);
    setModalData(data);
    console.log('Abriendo modal:', type, data);
    
    // Inicializar formData según el tipo de modal
    if (data) {
      switch (type) {
        case 'editDocente':
          setFormData({
            id: data.id,
            cedula: data.cedula,
            nombre: data.nombre,
            apellido: data.apellido,
            email: data.email,
            telefono: data.telefono
          });
          break;
        case 'editAlumno':
          setFormData({
            id: data.id || data._id,
            cedula: data.cedula,
            nombre: data.nombre,
            apellido: data.apellido || '',
            fechaNacimiento: data.fechaNacimiento,
            lugarNacimiento: data.lugarNacimiento || '',
            sexo: data.sexo || 'Otro',
            grupo: data.grupo || '',
            ef: data.ef || '',
            edad: data.edad,
            esMenorDeEdad: data.esMenorDeEdad
          });
          break;
        case 'editMateria':
          setFormData({
            id: data.id,
            codigo: data.codigo,
            nombre: data.nombre,
            descripcion: data.descripcion
          });
          break;
        case 'editAsignacion':
          // Inicializar el formulario de asignación para edición
          setAsignacionFormData({
            id: data.id || data._id,
            materiaId: data.materiaId,
            profesorId: data.profesorId,
            alumnos: data.alumnos || [],
            modoEdicion: true
          });
          break;
        case 'addActividad':
          // Establecer la asignación seleccionada
          setAsignacionSeleccionada(data);
          // Inicializar el formulario de actividad
          setActividadFormData({
            nombre: '',
            descripcion: '',
            fecha: new Date().toISOString().split('T')[0],
            porcentaje: 0
          });
          break;
        case 'viewActividades':
          // Establecer la asignación seleccionada para ver sus actividades
          setAsignacionSeleccionada(data);
          break;
        case 'calificarActividad':
          // Inicializar el formulario de calificaciones
          const calificacionesIniciales = data.actividad.calificaciones || [];
          setFormData({
            calificaciones: calificacionesIniciales
          });
          break;
        case 'editPeriodo':
          // Extraer año y número del ID del periodo (formato: P2025-1)
          const periodoInfo = data.id.substring(1).split('-');
          setFormData({
            id: data.id,
            anio: periodoInfo[0],
            numero: periodoInfo[1],
            fechaInicio: data.fechaInicio,
            fechaFin: data.fechaFin,
            activo: data.activo
          });
          break;
        default:
          setFormData(data);
      }
    } else {
      // Limpiar formData para formularios de creación
      switch (type) {
        case 'addAlumno':
          // Inicializar con valores por defecto para nuevo alumno
          setFormData({
            nombre: '',
            cedula: 'N/P',
            fechaNacimiento: '',
            edad: 0,
            esMenorDeEdad: false
          });
          break;
        case 'addAsignacion':
          // Inicializar el formulario de asignación
          setAsignacionFormData({
            materiaId: '',
            profesorId: '',
            alumnos: [],
            modoEdicion: false
          });
          break;
        default:
          // Limpiar formData para otros formularios de creación
          setFormData({});
      }
    }
    
    setShowModal(true);
  };

  // Función para renderizar el contenido del modal según su tipo
  const renderModalContent = () => {
    switch (modalType) {
      case 'addPeriodo':
      case 'editPeriodo':
        return (
          <div>
            <div className="bg-gray-100 px-4 py-3 border-b border-gray-200">
              <h3 className="text-lg font-medium text-gray-900">
                {modalType === 'addPeriodo' ? 'Agregar Nuevo Periodo' : 'Editar Periodo'}
              </h3>
            </div>
            <form onSubmit={(e) => modalType === 'addPeriodo' ? handleAddPeriodo(e) : handleEditPeriodo(e, modalData?.id)}>
              <div className="px-4 py-5 space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Año</label>
                    <input
                      type="number"
                      name="anio"
                      value={formData.anio || ''}
                      onChange={handleFormChange}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      min="2020"
                      max="2030"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Número</label>
                    <select
                      name="numero"
                      value={formData.numero || '1'}
                      onChange={handleFormChange}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      required
                    >
                      <option value="1">1</option>
                      <option value="2">2</option>
                    </select>
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Fecha de Inicio</label>
                    <input
                      type="date"
                      name="fechaInicio"
                      value={formData.fechaInicio || ''}
                      onChange={handleFormChange}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Fecha de Fin</label>
                    <input
                      type="date"
                      name="fechaFin"
                      value={formData.fechaFin || ''}
                      onChange={handleFormChange}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      required
                    />
                  </div>
                </div>
                <div className="flex items-center">
                  <input
                    type="checkbox"
                    id="activo"
                    name="activo"
                    checked={formData.activo || false}
                    onChange={handleFormChange}
                    className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                  />
                  <label htmlFor="activo" className="ml-2 block text-sm text-gray-900">
                    Periodo Activo
                  </label>
                </div>
              </div>
              <div className="bg-gray-50 px-4 py-3 flex justify-end space-x-3">
                <button
                  type="button"
                  onClick={() => setShowModal(false)}
                  className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                >
                  {modalType === 'addPeriodo' ? 'Agregar' : 'Guardar Cambios'}
                </button>
              </div>
            </form>
          </div>
        );
      case 'addDocente':
      case 'editDocente':
        return (
          <div className="p-6">
            <h3 className="text-lg font-medium text-gray-900 mb-4">
              {modalType === 'addDocente' ? 'Agregar Docente' : 'Editar Docente'}
            </h3>
            <form onSubmit={modalType === 'addDocente' ? handleAddDocente : handleEditDocente}>
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Cédula</label>
                  <input
                    type="text"
                    name="cedula"
                    value={formData.cedula || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                  <input
                    type="text"
                    name="nombre"
                    value={formData.nombre || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
                  <input
                    type="text"
                    name="apellido"
                    value={formData.apellido || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                  <input
                    type="email"
                    name="email"
                    value={formData.email || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                  <input
                    type="tel"
                    name="telefono"
                    value={formData.telefono || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Especialidad</label>
                  <input
                    type="text"
                    name="especialidad"
                    value={formData.especialidad || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Fecha de Ingreso</label>
                  <input
                    type="date"
                    name="fechaIngreso"
                    value={formData.fechaIngreso || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </div>
              <div className="flex justify-end space-x-3">
                <button
                  type="button"
                  onClick={() => setShowModal(false)}
                  className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                >
                  {modalType === 'addDocente' ? 'Agregar' : 'Guardar Cambios'}
                </button>
              </div>
            </form>
          </div>
        );

      case 'addAlumno':
      case 'editAlumno':
        // Verificar si estamos editando o agregando un alumno
        const isEditing = modalType === 'editAlumno';
        const existeCedula = isEditing && formData.cedula && formData.cedula !== 'N/P';
        
        // Calcular la edad si hay fecha de nacimiento
        let edad = 0;
        let esMenorDeEdad = false;
        
        if (formData.fechaNacimiento) {
          edad = calcularEdad(formData.fechaNacimiento);
          esMenorDeEdad = edad < 18;
        }
        
        return (
          <div className="p-6">
            <h3 className="text-lg font-medium text-gray-900 mb-4">
              {isEditing ? 'Editar Alumno' : 'Agregar Alumno'}
            </h3>
            <form onSubmit={(e) => isEditing ? handleEditAlumno(e) : handleAddAlumno(e)}>
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                  <input
                    type="text"
                    name="nombre"
                    value={formData.nombre || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                    placeholder="Nombre del estudiante"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
                  <input
                    type="text"
                    name="apellido"
                    value={formData.apellido || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                    placeholder="Apellido del estudiante"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Cédula</label>
                  <input
                    type="text"
                    name="cedula"
                    value={formData.cedula || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder={existeCedula ? formData.cedula : 'N/P'}
                    disabled={!existeCedula && isEditing}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Fecha de Nacimiento</label>
                  <input
                    type="date"
                    name="fechaNacimiento"
                    value={formData.fechaNacimiento || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Lugar de Nacimiento</label>
                  <input
                    type="text"
                    name="lugarNacimiento"
                    value={formData.lugarNacimiento || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Ciudad, País"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Sexo</label>
                  <select
                    name="sexo"
                    value={formData.sexo || 'Otro'}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="M">Masculino</option>
                    <option value="F">Femenino</option>
                    <option value="Otro">Otro</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">EF</label>
                  <input
                    type="text"
                    name="ef"
                    value={formData.ef || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Información EF"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Edad</label>
                  <div className="flex items-center h-10 px-3 py-2 border border-gray-300 rounded-md bg-gray-50">
                    {edad} años
                  </div>
                </div>
                <div className="col-span-2">
                  <div className="flex items-center mt-2">
                    <div className={`mr-2 w-4 h-4 rounded-full ${esMenorDeEdad ? 'bg-red-500' : 'bg-green-500'}`}></div>
                    <span className="text-sm font-medium">
                      {esMenorDeEdad ? 'Es menor de edad' : 'Es mayor de edad'}
                    </span>
                  </div>
                </div>
              </div>
              <div className="flex justify-end space-x-3">
                <button
                  type="button"
                  onClick={() => setShowModal(false)}
                  className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                >
                  {isEditing ? 'Guardar Cambios' : 'Agregar'}
                </button>
              </div>
            </form>
          </div>
        );
        
      case 'addMateria':
      case 'editMateria':
        return (
          <div className="p-6">
            <h3 className="text-lg font-medium text-gray-900 mb-4">
              {modalType === 'addMateria' ? 'Agregar Materia' : 'Editar Materia'}
            </h3>
            <form onSubmit={modalType === 'addMateria' ? handleAddMateria : handleEditMateria}>
              <div className="grid grid-cols-1 gap-4 mb-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Código</label>
                  <input
                    type="text"
                    name="codigo"
                    value={formData.codigo || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                  <input
                    type="text"
                    name="nombre"
                    value={formData.nombre || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                  <textarea
                    name="descripcion"
                    value={formData.descripcion || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    rows="3"
                    required
                  ></textarea>
                </div>
              </div>
              <div className="flex justify-end space-x-3">
                <button
                  type="button"
                  onClick={() => setShowModal(false)}
                  className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                >
                  {modalType === 'addMateria' ? 'Agregar' : 'Guardar Cambios'}
                </button>
              </div>
            </form>
          </div>
        );
        
      case 'addAsignacion':
      case 'editAsignacion':
        return (
          <div className="p-6">
            <h3 className="text-lg font-medium text-gray-900 mb-4">
              {modalType === 'addAsignacion' ? 'Crear Nueva Asignación' : 'Editar Asignación'}
            </h3>
            <form onSubmit={modalType === 'addAsignacion' ? handleAddAsignacion : handleEditAsignacion}>
              <div className="grid grid-cols-1 gap-4 mb-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Materia *</label>
                  <select
                    name="materiaId"
                    value={asignacionFormData.materiaId || ''}
                    onChange={handleAsignacionFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  >
                    <option value="">Seleccione una materia</option>
                    {materias.map(materia => (
                      <option key={materia.id || materia._id} value={materia.id || materia._id}>
                        {materia.codigo} - {materia.nombre}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Profesor *</label>
                  <select
                    name="profesorId"
                    value={asignacionFormData.profesorId || ''}
                    onChange={handleAsignacionFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  >
                    <option value="">Seleccione un profesor</option>
                    {profesores.map(profesor => (
                      <option key={profesor.id || profesor._id} value={profesor.id || profesor._id}>
                        {profesor.nombre} {profesor.apellido}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Año *</label>
                  <select
                    name="anio"
                    value={asignacionFormData.anio || '1 año'}
                    onChange={handleAsignacionFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  >
                    <option value="1 año">1 año</option>
                    <option value="2 año">2 año</option>
                    <option value="3 año">3 año</option>
                    <option value="4 año">4 año</option>
                    <option value="5 año">5 año</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Alumnos</label>
                  
                  {/* Campo de búsqueda de alumnos */}
                  <div className="mb-2">
                    <div className="flex items-center">
                      <input
                        type="text"
                        placeholder="Buscar alumno por nombre..."
                        value={searchAlumno}
                        onChange={(e) => setSearchAlumno(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      {searchAlumno && (
                        <button
                          type="button"
                          onClick={() => setSearchAlumno('')}
                          className="ml-2 text-gray-500 hover:text-gray-700"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                          </svg>
                        </button>
                      )}
                    </div>
                  </div>
                  
                  {/* Lista de alumnos filtrada */}
                  <select
                    multiple
                    name="alumnos"
                    value={asignacionFormData.alumnos || []}
                    onChange={(e) => {
                      const selectedOptions = Array.from(e.target.selectedOptions, option => option.value);
                      handleAlumnosChange(selectedOptions);
                    }}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    size="5"
                  >
                    {alumnos
                      .filter(alumno => {
                        const nombreCompleto = `${alumno.nombre} ${alumno.apellido || ''} ${alumno.cedula || ''}`;
                        return searchAlumno === '' || 
                               nombreCompleto.toLowerCase().includes(searchAlumno.toLowerCase());
                      })
                      .map(alumno => (
                        <option key={alumno.id || alumno._id} value={alumno.id || alumno._id}>
                          {alumno.nombre} {alumno.cedula !== 'N/P' ? `(${alumno.cedula})` : ''}
                        </option>
                      ))}
                  </select>
                  
                  {/* Instrucciones y conteo de alumnos */}
                  <div className="flex justify-between mt-1">
                    <p className="text-xs text-gray-500">Mantenga presionado Ctrl para seleccionar múltiples alumnos</p>
                    <p className="text-xs text-gray-500">
                      {asignacionFormData.alumnos ? asignacionFormData.alumnos.length : 0} alumno(s) seleccionado(s)
                    </p>
                  </div>
                </div>
              </div>
              <div className="flex justify-end space-x-3">
                <button
                  type="button"
                  onClick={() => {
                    setShowModal(false);
                    setAsignacionFormData({
                      materiaId: '',
                      profesorId: '',
                      alumnos: [],
                      periodo: '',
                      anio: '1 año',
                      modoEdicion: false,
                      usarPeriodoExistente: false
                    });
                  }}
                  className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                >
                  {modalType === 'addAsignacion' ? 'Crear Asignación' : 'Guardar Cambios'}
                </button>
              </div>
            </form>
          </div>
        );
        
      case 'addActividad':
        return (
          <div className="p-6">
            <h3 className="text-lg font-medium text-gray-900 mb-4">Agregar Actividad</h3>
            <div className="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
              <p className="text-sm text-gray-700">
                <span className="font-medium">Materia: </span>
                {(() => {
                  const materia = materias.find(m => m.id === modalData?.materiaId || m._id === modalData?.materiaId);
                  return materia ? `${materia.codigo} - ${materia.nombre}` : 'N/A';
                })()}
              </p>
              <p className="text-sm text-gray-700">
                <span className="font-medium">Profesor: </span>
                {(() => {
                  const profesor = profesores.find(p => p.id === modalData?.profesorId || p._id === modalData?.profesorId);
                  return profesor ? `${profesor.nombre} ${profesor.apellido || ''}` : 'N/A';
                })()}
              </p>
            </div>
            <form onSubmit={handleAddActividad}>
              <div className="grid grid-cols-1 gap-4 mb-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                  <input
                    type="text"
                    name="nombre"
                    value={actividadFormData.nombre || ''}
                    onChange={handleActividadFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                  <textarea
                    name="descripcion"
                    value={actividadFormData.descripcion || ''}
                    onChange={handleActividadFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    rows="3"
                  ></textarea>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Fecha *</label>
                  <input
                    type="date"
                    name="fecha"
                    value={actividadFormData.fecha || ''}
                    onChange={handleActividadFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Porcentaje *</label>
                  <input
                    type="number"
                    name="porcentaje"
                    value={actividadFormData.porcentaje || ''}
                    onChange={handleActividadFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    min="1"
                    max="100"
                    required
                  />
                </div>
              </div>
              <div className="flex justify-end space-x-3">
                <button
                  type="button"
                  onClick={() => {
                    setShowModal(false);
                    setActividadFormData({
                      nombre: '',
                      descripcion: '',
                      fecha: new Date().toISOString().split('T')[0],
                      porcentaje: 0
                    });
                  }}
                  className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                >
                  Agregar Actividad
                </button>
              </div>
            </form>
          </div>
        );
        
      case 'viewActividades':
        return (
          <div className="p-6">
            <h3 className="text-lg font-medium text-gray-900 mb-4">Actividades y Calificaciones</h3>
            <div className="mb-4">
              <p className="text-gray-700">
                <span className="font-medium">Materia: </span>
                {(() => {
                  const materia = materias.find(m => m.id === asignacionSeleccionada?.materiaId || m._id === asignacionSeleccionada?.materiaId);
                  return materia ? `${materia.codigo} - ${materia.nombre}` : 'N/A';
                })()}
              </p>
              <p className="text-gray-700">
                <span className="font-medium">Docente: </span>
                {(() => {
                  const profesor = profesores.find(p => p.id === asignacionSeleccionada?.profesorId || p._id === asignacionSeleccionada?.profesorId);
                  return profesor ? `${profesor.nombre} ${profesor.apellido || ''}` : 'N/A';
                })()}
              </p>
            </div>
            
            {asignacionSeleccionada?.actividades && asignacionSeleccionada.actividades.length > 0 ? (
              <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Porcentaje</th>
                      <th scope="col" className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ACCIONES</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {asignacionSeleccionada.actividades.map((actividad, index) => (
                      <tr key={actividad.id || actividad._id || index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{actividad.nombre}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{actividad.descripcion || '-'}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{new Date(actividad.fecha).toLocaleDateString()}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{actividad.porcentaje}%</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                          <button
                            onClick={() => openModal('calificarActividad', { asignacion: asignacionSeleccionada, actividad })}
                            className="text-blue-600 hover:text-blue-900"
                          >
                            Calificar
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            ) : (
              <p className="text-gray-500 italic">No hay actividades registradas para esta asignación.</p>
            )}
            
            <div className="mt-6 flex justify-end space-x-3">
              <button
                onClick={() => setShowModal(false)}
                className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
              >
                Cerrar
              </button>
              <button
                onClick={() => openModal('addActividad', asignacionSeleccionada)}
                className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
              >
                Agregar Actividad
              </button>
            </div>
          </div>
        );
        
      case 'calificarActividad':
        const asignacion = modalData?.asignacion;
        const actividad = modalData?.actividad;
        
        return (
          <div className="p-6">
            <h3 className="text-lg font-medium text-gray-900 mb-4">
              Calificar Actividad: {actividad?.nombre}
            </h3>
            <div className="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
              <p className="text-sm text-gray-700">
                <span className="font-medium">Materia:</span> {
                  materias.find(m => m.id === asignacion?.materiaId || m._id === asignacion?.materiaId)?.nombre || 'N/A'
                }
              </p>
              <p className="text-sm text-gray-700">
                <span className="font-medium">Fecha:</span> {new Date(actividad?.fecha).toLocaleDateString()}
              </p>
              <p className="text-sm text-gray-700">
                <span className="font-medium">Porcentaje:</span> {actividad?.porcentaje}%
              </p>
            </div>
            
            <form onSubmit={(e) => {
              e.preventDefault();
              // Aquí iría la lógica para guardar las calificaciones
              handleSaveCalificaciones(asignacion.id, actividad.id, formData.calificaciones);
            }}>
              <div className="overflow-x-auto mb-4">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th scope="col" className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alumno</th>
                      <th scope="col" className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Calificación</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {asignacion?.alumnos?.map((alumnoId, index) => {
                      const alumno = alumnos.find(a => a.id === alumnoId || a._id === alumnoId);
                      const calificacion = actividad?.calificaciones?.find(c => c.alumnoId === alumnoId)?.nota || '';
                      
                      return (
                        <tr key={alumnoId} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                          <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                            {alumno ? alumno.nombre : 'Alumno no encontrado'}
                          </td>
                          <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                            <input
                              type="number"
                              min="0"
                              max="20"
                              step="0.1"
                              name={`calificacion-${alumnoId}`}
                              defaultValue={calificacion}
                              onChange={(e) => {
                                // Actualizar las calificaciones en el formData
                                const calificaciones = formData.calificaciones || [];
                                const index = calificaciones.findIndex(c => c.alumnoId === alumnoId);
                                
                                if (index !== -1) {
                                  calificaciones[index].nota = parseFloat(e.target.value);
                                } else {
                                  calificaciones.push({
                                    alumnoId,
                                    nota: parseFloat(e.target.value)
                                  });
                                }
                                
                                setFormData({
                                  ...formData,
                                  calificaciones
                                });
                              }}
                              className="w-20 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
              
              <div className="flex justify-end space-x-3">
                <button
                  type="button"
                  onClick={() => setShowModal(false)}
                  className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                >
                  Guardar Calificaciones
                </button>
              </div>
            </form>
          </div>
        );
        
      case 'addAsignacion':
      case 'editAsignacion':
        return (
          <div className="p-6">
            <h3 className="text-lg font-medium text-gray-900 mb-4">
              {modalType === 'addAsignacion' ? 'Crear Asignación' : 'Editar Asignación'}
            </h3>
            <form onSubmit={modalType === 'addAsignacion' ? handleAddAsignacion : handleEditAsignacion}>
              <div className="grid grid-cols-1 gap-4 mb-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Materia</label>
                  <select
                    name="materiaId"
                    value={formData.materiaId || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  >
                    <option value="">Seleccione una materia</option>
                    {materias.map(materia => (
                      <option key={materia.id} value={materia.id}>
                        {materia.codigo} - {materia.nombre}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Docente</label>
                  <select
                    name="docenteId"
                    value={formData.docenteId || ''}
                    onChange={handleFormChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  >
                    <option value="">Seleccione un docente</option>
                    {docentes.map(docente => (
                      <option key={docente.id} value={docente.id}>
                        {docente.nombre} {docente.apellido}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Alumnos</label>
                  <div className="border border-gray-300 rounded-md p-3 max-h-60 overflow-y-auto">
                    <div className="space-y-3 mb-4">
                      <div className="flex items-center">
                        <input
                          id="reporte-estudiantes"
                          name="tipo-reporte"
                          type="radio"
                          className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                          checked={tipoReporte === 'estudiantes'}
                          onChange={() => setTipoReporte('estudiantes')}
                        />
                        <label htmlFor="reporte-estudiantes" className="ml-2 block text-sm text-gray-700">
                          Estudiantes por Filtros (idAA)
                        </label>
                      </div>
                      <div className="flex items-center">
                        <input
                          id="reporte-todos-estudiantes"
                          name="tipo-reporte"
                          type="radio"
                          className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                          checked={tipoReporte === 'todosEstudiantes'}
                          onChange={() => setTipoReporte('todosEstudiantes')}
                        />
                        <label htmlFor="reporte-todos-estudiantes" className="ml-2 block text-sm text-gray-700">
                          Todos los Estudiantes (idAA)
                        </label>
                      </div>
                      <div className="flex items-center">
                        <input
                          id="reporte-todos-docentes"
                          name="tipo-reporte"
                          type="radio"
                          className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                          checked={tipoReporte === 'todosDocentes'}
                          onChange={() => setTipoReporte('todosDocentes')}
                        />
                        <label htmlFor="reporte-todos-docentes" className="ml-2 block text-sm text-gray-700">
                          Todos los Docentes (idAP)
                        </label>
                      </div>
                      <div className="flex items-center">
                        <input
                          id="reporte-asignaciones"
                          name="tipo-reporte"
                          type="radio"
                          className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                          checked={tipoReporte === 'asignaciones'}
                          onChange={() => setTipoReporte('asignaciones')}
                        />
                        <label htmlFor="reporte-asignaciones" className="ml-2 block text-sm text-gray-700">
                          Todas las Asignaciones (idAAS)
                        </label>
                      </div>
                    </div>
                    {alumnos.map(alumno => (
                      <div key={alumno.id} className="flex items-center mb-2">
                        <input
                          type="checkbox"
                          id={`alumno-${alumno.id}`}
                          name="alumnos"
                          value={alumno.id}
                          checked={formData.alumnos?.includes(alumno.id)}
                          onChange={(e) => {
                            const alumnId = e.target.value;
                            if (e.target.checked) {
                              setFormData(prev => ({
                                ...prev,
                                alumnos: [...(prev.alumnos || []), alumnId]
                              }));
                            } else {
                              setFormData(prev => ({
                                ...prev,
                                alumnos: (prev.alumnos || []).filter(id => id !== alumnId)
                              }));
                            }
                          }}
                          className="mr-2"
                        />
                        <label htmlFor={`alumno-${alumno.id}`} className="text-sm">
                          <StudentNameDisplay student={alumno} showId={true} />
                        </label>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
              <div className="flex justify-end space-x-3">
                <button
                  type="button"
                  onClick={() => setShowModal(false)}
                  className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                >
                  {modalType === 'addAsignacion' ? 'Crear' : 'Guardar Cambios'}
                </button>
              </div>
            </form>
          </div>
        );
        
      case 'viewAlumnos':
        return (
          <div className="p-6 bg-white rounded-lg shadow-md">
            <h3 className="text-lg font-medium text-gray-900 mb-4 border-b pb-2">
              Alumnos de {asignacionSeleccionada?.materiaNombre || 'la asignación'}
            </h3>
            <div className="overflow-x-auto mb-4">
              <table className="min-w-full divide-y divide-gray-200 border">
                <thead className="bg-gray-100">
                  <tr>
                    <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider border-b">Nombre</th>
                    <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider border-b">Identificación</th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {(() => {
                    // Añadir logs para depuración
                    console.log('Estado de asignacionSeleccionada:', asignacionSeleccionada);
                    
                    if (asignacionSeleccionada?.alumnosInfo && asignacionSeleccionada.alumnosInfo.length > 0) {
                      console.log('Rendering student list in modal:', asignacionSeleccionada.alumnosInfo);
                      return asignacionSeleccionada.alumnosInfo.map((alumno, index) => {
                        console.log('Rendering student:', alumno);
                        return (
                          <tr key={alumno.id || index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50 hover:bg-blue-50'}>
                            <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 border-r">
                            {alumno.nombre || 'Sin nombre'} {alumno.apellido || 'Sin apellido'}
                            </td>
                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                              {alumno.cedula && alumno.cedula !== 'N/A' ? alumno.cedula : 'Cargando...'}
                            </td>
                          </tr>
                        );
                      });
                    } else {
                      return (
                        <tr>
                          <td colSpan="2" className="px-4 py-4 text-center text-sm text-gray-500">
                            No hay alumnos asignados a esta materia.
                          </td>
                        </tr>
                      );
                    }
                    return null;
                  })()}
                </tbody>
              </table>
            </div>
            <div className="flex justify-end mt-4">
              <button
                onClick={() => setShowModal(false)}
                className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
              >
                Cerrar
              </button>
            </div>
          </div>
        );
        
      default:
        return (
          <div className="p-6">
            <h3 className="text-lg font-medium text-gray-900 mb-4">Acción no implementada</h3>
            <p className="text-gray-600 mb-4">Esta funcionalidad aún no ha sido implementada.</p>
            <div className="flex justify-end">
              <button
                onClick={() => setShowModal(false)}
                className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
              >
                Cerrar
              </button>
            </div>
          </div>
        );
    }
  };

  // Renderizado del componente
  return (
    <div className="min-h-screen bg-gray-100 flex flex-col">
      {/* Estilos CSS para animaciones */}
      <style jsx global>{`
        @keyframes fadeInUp {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInLeft {
          from { opacity: 0; transform: translateX(-20px); }
          to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes fadeInRight {
          from { opacity: 0; transform: translateX(20px); }
          to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes pulse {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.03); }
        }
        
        @keyframes shimmer {
          0% { background-position: -1000px 0; }
          100% { background-position: 1000px 0; }
        }
        
        .card-animate {
          animation: fadeInUp 0.5s ease forwards;
        }
        
        .card-animate-delay-1 {
          animation-delay: 0.1s;
        }
        
        .card-animate-delay-2 {
          animation-delay: 0.2s;
        }
        
        .card-animate-delay-3 {
          animation-delay: 0.3s;
        }
        
        .card-hover-effect {
          transition: all 0.3s ease;
        }
        
        .card-hover-effect:hover {
          transform: translateY(-5px);
          box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
      `}</style>
      {/* Barra superior */}
      <header className="bg-gradient-to-r from-blue-600 to-sky-500 shadow-md z-10">
        <div className="max-w-7xl mx-auto px-0 sm:px-0 lg:px-0">
          <div className="flex justify-between items-center py-4">
            <div className="flex items-center pl-2">
              {/* Botón para colapsar/expandir sidebar */}
              <button 
                onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
                className="p-2 mr-2 rounded-md text-white hover:text-sky-100 hover:bg-blue-700/50 focus:outline-none transition-all"
              >
                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                </svg>
              </button>
              {/* Icono de educación en lugar de imagen */}
              <div className="mr-2 text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" className="bi bi-mortarboard-fill" viewBox="0 0 16 16">
                  <path d="M8.211 2.047a.5.5 0 0 0-.422 0l-7.5 3.5a.5.5 0 0 0 .025.917l7.5 3a.5.5 0 0 0 .372 0L14 7.14V13a1 1 0 0 0-1 1v2h3v-2a1 1 0 0 0-1-1V6.739l.686-.275a.5.5 0 0 0 .025-.917l-7.5-3.5Z"/>
                  <path d="M4.176 9.032a.5.5 0 0 0-.656.327l-.5 1.7a.5.5 0 0 0 .294.605l4.5 1.8a.5.5 0 0 0 .372 0l4.5-1.8a.5.5 0 0 0 .294-.605l-.5-1.7a.5.5 0 0 0-.656-.327L8 10.466 4.176 9.032Z"/>
                </svg>
              </div>
              <div>
                <h1 className="text-xl font-bold text-white">Academico360 - Control de Estudio</h1>
                {userData && (
                  <>
                    {console.log('Valores de identificadores en sidebar:', {
                      idID: sessionStorage.getItem('idID') || localStorage.getItem('idID'),
                      idI: sessionStorage.getItem('idI') || localStorage.getItem('idI'),
                      idA: sessionStorage.getItem('idA') || localStorage.getItem('idA')
                    })}
                    <div id="institucion" className="text-sm font-medium text-sky-100">
                      Acacias
                    </div>
                  </>
                )}
              </div>
            </div>
            <div>
              <button
                onClick={handleLogout}
                className="px-3 py-1 bg-white text-blue-700 rounded-md hover:bg-sky-100 transition-colors font-medium shadow-sm mr-2"
              >
                Cerrar Sesión
              </button>
              <button
                onClick={() => window.location.href = '/reportes'}
                className="px-3 py-1 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors font-medium shadow-sm"
              >
                Reportes
              </button>
            </div>
          </div>
        </div>
      </header>

      {/* Estructura principal con sidebar */}
      <div className="flex flex-1 overflow-hidden">
        {/* Sidebar vertical */}
        <aside className={`bg-gradient-to-b from-blue-700 to-blue-900 shadow-lg transition-all duration-300 ${sidebarCollapsed ? 'w-16' : 'w-64'}`}>
          <nav className="p-4 h-full">
            <ul className="space-y-3">
              {/* Renderizado condicional basado en el tipo de usuario */}
              {/* Opciones solo para usuarios de tipo 'control' */}
              {userType === 'control' && (
                <>
                  <li>
                    <button
                      className={`w-full flex items-center p-3 rounded-lg transition-all ${activeTab === 'docentes' ? 'bg-sky-500 text-white shadow-md' : 'text-white hover:bg-blue-600'}`}
                      onClick={() => setActiveTab('docentes')}
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                      </svg>
                      {!sidebarCollapsed && <span className="ml-3 font-medium">Gestión de Docentes</span>}
                    </button>
                  </li>
                  <li>
                    <button
                      className={`w-full flex items-center p-3 rounded-lg transition-all ${activeTab === 'alumnos' ? 'bg-sky-500 text-white shadow-md' : 'text-white hover:bg-blue-600'}`}
                      onClick={() => setActiveTab('alumnos')}
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path d="M12 14l9-5-9-5-9 5 9 5z" />
                        <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998a12.078 12.078 0 01.665-6.479L12 14z" />
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998a12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222" />
                      </svg>
                      {!sidebarCollapsed && <span className="ml-3 font-medium">Gestión de Alumnos</span>}
                    </button>
                  </li>
                  <li>
                    <button
                      className={`w-full flex items-center p-3 rounded-lg transition-all ${activeTab === 'materias' ? 'bg-sky-500 text-white shadow-md' : 'text-white hover:bg-blue-600'}`}
                      onClick={() => setActiveTab('materias')}
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                      </svg>
                      {!sidebarCollapsed && <span className="ml-3 font-medium">Gestión de Materias</span>}
                    </button>
                  </li>
                  <li>
                    <button
                      className={`w-full flex items-center p-3 rounded-lg transition-all text-white hover:bg-blue-600`}
                      onClick={() => window.location.href = '/representantes'}
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                      </svg>
                      {!sidebarCollapsed && <span className="ml-3 font-medium">Gestión de Representantes</span>}
                    </button>
                  </li>
                </>
              )}
              
              {/* Asignaciones y Calificaciones - Visible para todos los usuarios */}
              <li>
                <button
                  className={`w-full flex items-center p-3 rounded-lg transition-all ${activeTab === 'asignaciones' ? 'bg-sky-500 text-white shadow-md' : 'text-white hover:bg-blue-600'}`}
                  onClick={() => setActiveTab('asignaciones')}
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                  </svg>
                  {!sidebarCollapsed && <span className="ml-3 font-medium">Asignaciones y Calificaciones</span>}
                </button>
              </li>
              
              {/* Reportes - Visible solo para docentes y control */}

            </ul>
          </nav>
        </aside>

        {/* Contenido principal */}
        <main className="flex-1 p-6 overflow-auto bg-sky-50">
        {loading ? (
          <div className="flex flex-col justify-center items-center h-full">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
            <p className="text-gray-700 font-medium">Cargando datos...</p>
            <p className="text-gray-500 text-sm mt-2">Esto puede tomar unos segundos</p>
          </div>
        ) : error ? (
          <div className="flex justify-center items-center h-full">
            <div className="bg-red-50 border border-red-200 rounded-md p-4 max-w-lg">
              <div className="flex">
                <div className="flex-shrink-0">
                  <svg className="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                  </svg>
                </div>
                <div className="ml-3">
                  <h3 className="text-sm font-medium text-red-800">Error</h3>
                  <div className="mt-2 text-sm text-red-700">
                    <p>{error}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        ) : (
          <div>

            {/* Título de la sección activa */}
            <div className="mb-6">
              <h1 className="text-2xl font-bold text-gray-800">
                {activeTab === 'docentes' && 'Gestión de Docentes'}
                {activeTab === 'alumnos' && 'Gestión de Alumnos'}
                {activeTab === 'materias' && 'Gestión de Materias'}
                {activeTab === 'asignaciones' && 'Asignaciones y Calificaciones'}
              </h1>
              <div className="h-1 w-20 bg-blue-500 mt-2 rounded"></div>
            </div>

            {/* Contenido según la pestaña seleccionada */}
            <div className="bg-white shadow-md rounded-lg p-6">
              {/* Sección de Reportes */}
              
              {/* Gestión de Profesores */}
              {activeTab === 'docentes' && (
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-semibold text-gray-800">Gestión de Profesores</h2>
                    <button
                      onClick={() => setShowProfesorForm(true)}
                      className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                    >
                      Agregar Profesor
                    </button>
                  </div>

                  
                  {/* Filtros de búsqueda */}
                  <div className="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 className="text-md font-medium text-gray-700 mb-3">Filtrar profesores</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label htmlFor="searchProfesorNombre" className="block text-sm font-medium text-gray-700 mb-1">Nombre o Apellido</label>
                        <input
                          type="text"
                          id="searchProfesorNombre"
                          placeholder="Buscar por nombre o apellido..."
                          className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          value={searchProfesorNombre}
                          onChange={(e) => setSearchProfesorNombre(e.target.value)}
                        />
                      </div>
                      <div>
                        <label htmlFor="searchProfesorCedula" className="block text-sm font-medium text-gray-700 mb-1">Cédula</label>
                        <input
                          type="text"
                          id="searchProfesorCedula"
                          placeholder="Buscar por cédula..."
                          className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          value={searchProfesorCedula}
                          onChange={(e) => setSearchProfesorCedula(e.target.value)}
                        />
                      </div>
                    </div>
                  </div>
                  
                  {/* Formulario para agregar/editar profesor */}
                  {showProfesorForm && (
                    <div id="profesorForm" className="mb-6 bg-white p-6 rounded-lg border border-gray-300 shadow-md">
                      <h3 className="text-lg font-medium text-gray-800 mb-4">
                        {profesorFormData.modoEdicion ? 'Editar Profesor' : 'Agregar Nuevo Profesor'}
                      </h3>
                      <form onSubmit={profesorFormData.modoEdicion ? handleEditProfesor : handleAddProfesor}>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                          <div>
                            <label htmlFor="nombre" className="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                            <input
                              type="text"
                              id="nombre"
                              name="nombre"
                              required
                              placeholder='Indique el nombre del profesor'
                              className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              value={profesorFormData.nombre}
                              onChange={handleProfesorFormChange}
                            />
                          </div>
                          <div>
                            <label htmlFor="apellido" className="block text-sm font-medium text-gray-700 mb-1">Apellido *</label>
                            <input
                              type="text"
                              id="apellido"
                              name="apellido"
                              required
                                                            placeholder='Indique el apellido del profesor'
                              className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              value={profesorFormData.apellido}
                              onChange={handleProfesorFormChange}
                            />
                          </div>
                          <div>
                            <label htmlFor="cedula" className="block text-sm font-medium text-gray-700 mb-1">Cédula</label>
                            <input
                              type="text"
                              id="cedula"
                              name="cedula"
                              placeholder='Indique la cedula del profesor'
                              className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              value={profesorFormData.cedula || ''}
                              onChange={handleProfesorFormChange}
                            />
                          </div>
                          <div>
                            <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input
                              type="email"
                              id="email"
                              name="email"
                                                            placeholder='Indique el correo del profesor'
                              className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              value={profesorFormData.email}
                              onChange={handleProfesorFormChange}
                            />
                          </div>
                          <div>
                            <label htmlFor="telefono" className="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                            <input
                              type="text"
                              id="telefono"
                              name="telefono"
                                                            placeholder='Indique el telefono del profesor'
                              className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              value={profesorFormData.telefono}
                              onChange={handleProfesorFormChange}
                            />
                          </div>
                          <div>
                            <label htmlFor="especialidad" className="block text-sm font-medium text-gray-700 mb-1">Especialidad</label>
                            <input
                              type="text"
                              id="especialidad"
                              name="especialidad"
                              placeholder='Indique la especialidad del profesor'
                              className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              value={profesorFormData.especialidad}
                              onChange={handleProfesorFormChange}
                            />
                          </div>
                          <div>
                            <label htmlFor="fechaIngreso" className="block text-sm font-medium text-gray-700 mb-1">Fecha de Ingreso</label>
                            <input
                              type="date"
                              id="fechaIngreso"
                              name="fechaIngreso"
                              className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              value={profesorFormData.fechaIngreso || ''}
                              onChange={handleProfesorFormChange}
                            />
                          </div>
                        </div>
                        <div className="flex justify-end space-x-3">
                          <button
                            type="button"
                            onClick={() => {
                              setShowProfesorForm(false);
                              setProfesorFormData({
                                nombre: '',
                                apellido: '',
                                cedula: 'N/P',
                                email: '',
                                telefono: '',
                                especialidad: '',
                                fechaIngreso: '',
                                modoEdicion: false
                              });
                            }}
                            className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
                          >
                            Cancelar
                          </button>
                          <button
                            type="submit"
                            className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                          >
                            {profesorFormData.modoEdicion ? 'Guardar Cambios' : 'Agregar Profesor'}
                          </button>
                        </div>
                      </form>
                    </div>
                  )}
                  
                  {/* Lista de profesores */}
                  <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                      {profesores
                        .filter(profesor => 
                          (searchProfesorNombre === '' || 
                            profesor.nombre.toLowerCase().includes(searchProfesorNombre.toLowerCase()) || 
                            profesor.apellido.toLowerCase().includes(searchProfesorNombre.toLowerCase())) &&
                          (searchProfesorCedula === '' || 
                            profesor.cedula.toLowerCase().includes(searchProfesorCedula.toLowerCase()))
                        )
                        .map((profesor, index) => (
                          <div 
                            key={profesor.id} 
                            className={`bg-gradient-to-br from-blue-50 to-white p-4 rounded-lg border-t-4 border-blue-500 border-r border-b border-l border-gray-200 shadow-md card-animate card-hover-effect card-animate-delay-${index % 3 + 1} transform transition-all duration-300 hover:shadow-xl hover:scale-105`}
                          >
                            <div className="flex justify-between items-start mb-3">
                              <div>
                                <h3 className="text-lg font-bold text-blue-700 group-hover:text-blue-800 transition-colors duration-300">{profesor.nombre} {profesor.apellido}</h3>
                                <p className="text-sm font-medium text-blue-600 bg-blue-50 inline-block px-2 py-1 rounded-md mt-1">Cédula: {profesor.cedula}</p>
                              </div>
                              <div className="flex space-x-2">
                                <button
                                  onClick={() => {
                                    setProfesorFormData({
                                      ...profesor,
                                      modoEdicion: true
                                    });
                                    setShowProfesorForm(true);
                                    // Scroll to the form
                                    setTimeout(() => {
                                      document.getElementById('profesorForm').scrollIntoView({ behavior: 'smooth' });
                                    }, 100);
                                  }}
                                  className="p-2 bg-blue-100 rounded-full text-blue-600 hover:bg-blue-200 hover:text-blue-800 transition-all duration-300 transform hover:scale-110"
                                >
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                  </svg>
                                </button>
                                <button
                                  onClick={() => handleDeleteProfesor(profesor.id)}
                                  className="p-2 bg-red-100 rounded-full text-red-600 hover:bg-red-200 hover:text-red-800 transition-all duration-300 transform hover:scale-110"
                                >
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                  </svg>
                                </button>
                              </div>
                            </div>
                            <div className="mt-3 space-y-2">
                              {profesor.email && (
                                <div className="flex items-center text-sm">
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                  </svg>
                                  <span className="text-gray-700">{profesor.email}</span>
                                </div>
                              )}
                              {profesor.telefono && (
                                <div className="flex items-center text-sm">
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                  </svg>
                                  <span className="text-gray-700">{profesor.telefono}</span>
                                </div>
                              )}
                              {profesor.especialidad && (
                                <div className="flex items-center text-sm">
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                  </svg>
                                  <span className="text-gray-700">{profesor.especialidad}</span>
                                </div>
                              )}
                              {profesor.fechaIngreso && (
                                <div className="flex items-center text-sm">
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                  </svg>
                                  <span className="text-gray-700">Fecha de Ingreso: {profesor.fechaIngreso}</span>
                                </div>
                              )}
                            </div>
                          </div>
                        ))
                      }
                      {profesores.filter(profesor => 
                        (searchProfesorNombre === '' || 
                          profesor.nombre.toLowerCase().includes(searchProfesorNombre.toLowerCase()) || 
                          profesor.apellido.toLowerCase().includes(searchProfesorNombre.toLowerCase())) &&
                        (searchProfesorCedula === '' || 
                          profesor.cedula.toLowerCase().includes(searchProfesorCedula.toLowerCase()))
                      ).length === 0 && (
                        <div className="col-span-3 py-6 text-center text-gray-500">
                          No se encontraron profesores con los criterios de búsqueda especificados.
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}
              
              {/* Gestión de Materias */}
              {activeTab === 'materias' && (
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-semibold text-gray-800">Gestión de Materias</h2>
                    <button
                      onClick={() => setShowMateriaForm(true)}
                      className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                    >
                      Agregar Materia
                    </button>
                  </div>
                  
                  {/* Filtros de búsqueda */}
                  <div className="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 className="text-md font-medium text-gray-700 mb-3">Filtrar materias</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label htmlFor="searchMateriaNombre" className="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                        <input
                          type="text"
                          id="searchMateriaNombre"
                          placeholder="Buscar por nombre..."
                          className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          value={searchMateriaNombre}
                          onChange={(e) => setSearchMateriaNombre(e.target.value)}
                        />
                      </div>
                      <div>
                        <label htmlFor="searchMateriaCodigo" className="block text-sm font-medium text-gray-700 mb-1">Código</label>
                        <input
                          type="text"
                          id="searchMateriaCodigo"
                          placeholder="Buscar por código..."
                          className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          value={searchMateriaCodigo}
                          onChange={(e) => setSearchMateriaCodigo(e.target.value)}
                        />
                      </div>
                    </div>
                  </div>
                  
                  {/* Formulario para agregar/editar materia */}
                  {showMateriaForm && (
                    <div id="materiaForm" className="mb-6 bg-white p-6 rounded-lg border border-gray-300 shadow-md">
                      <h3 className="text-lg font-medium text-gray-800 mb-4">
                        {materiaFormData.modoEdicion ? 'Editar Materia' : 'Agregar Nueva Materia'}
                      </h3>
                      <form onSubmit={materiaFormData.modoEdicion ? handleEditMateria : handleAddMateria}>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                          <div>
                            <label htmlFor="codigo" className="block text-sm font-medium text-gray-700 mb-1">Código *</label>
                            <input
                              type="text"
                              id="codigo"
                              name="codigo"
                              required
                              className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              value={materiaFormData.codigo}
                              placeholder="Indique el codigo, puedo ser numerico o alfanumerico"
                              onChange={handleMateriaFormChange}
                            />
                          </div>
                          <div>
                            <label htmlFor="nombre" className="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                            <input
                              type="text"
                              id="nombre"
                              name="nombre"
                              required
                              className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              value={materiaFormData.nombre}
                              placeholder="Indique el nombre de la materia"
                              onChange={handleMateriaFormChange}
                            />
                          </div>
                          <div className="md:col-span-2">
                            <label htmlFor="descripcion" className="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                            <textarea
                              id="descripcion"
                              name="descripcion"
                              rows="3"
                              className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              value={materiaFormData.descripcion}
                              onChange={handleMateriaFormChange}
                              placeholder="De una descripcion breve de la materia"
                            ></textarea>
                          </div>
                        </div>
                        <div className="flex justify-end space-x-3">
                          <button
                            type="button"
                            onClick={() => {
                              setShowMateriaForm(false);
                              setMateriaFormData({
                                codigo: '',
                                nombre: '',
                                descripcion: '',
                                modoEdicion: false
                              });
                            }}
                            className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
                          >
                            Cancelar
                          </button>
                          <button
                            type="submit"
                            className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                          >
                            {materiaFormData.modoEdicion ? 'Guardar Cambios' : 'Agregar Materia'}
                          </button>
                        </div>
                      </form>
                    </div>
                  )}
                  
                  {/* Lista de materias */}
                  <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                      {materias
                        .filter(materia => 
                          (searchMateriaNombre === '' || 
                            materia.nombre.toLowerCase().includes(searchMateriaNombre.toLowerCase())) &&
                          (searchMateriaCodigo === '' || 
                            materia.codigo.toLowerCase().includes(searchMateriaCodigo.toLowerCase()))
                        )
                        .map((materia, index) => (
                          <div key={materia.id} className={`bg-gradient-to-br from-indigo-50 to-white p-4 rounded-lg border-t-4 border-indigo-500 border-r border-b border-l border-gray-200 shadow-md card-animate card-hover-effect card-animate-delay-${index % 3 + 1} transform transition-all duration-300 hover:shadow-xl hover:scale-105`}>
                            <div className="flex justify-between items-start mb-3">
                              <div>
                                <h3 className="text-lg font-bold text-indigo-700 group-hover:text-indigo-800 transition-colors duration-300">{materia.nombre}</h3>
                                <div className="mt-2">
                                  <p className="text-sm font-medium text-indigo-600 bg-indigo-50 inline-block px-2 py-1 rounded-md">Código: {materia.codigo || 'N/A'}</p>
                                  <div className="mt-3 p-3 bg-gray-50 rounded-md border-l-2 border-indigo-400">
                                    <div className="flex items-start">
                                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-indigo-500 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                      </svg>
                                      <span className="text-gray-700">{materia.descripcion || 'Sin descripción'}</span>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              <div className="flex space-x-2">
                                <button
                                  onClick={() => {
                                    setMateriaFormData({
                                       ...materia,
                                       modoEdicion: true
                                     });
                                     setShowMateriaForm(true);
                                     // Scroll to the form
                                     setTimeout(() => {
                                       document.getElementById('materiaForm').scrollIntoView({ behavior: 'smooth' });
                                     }, 100);
                                  }}
                                  className="p-2 bg-indigo-100 rounded-full text-indigo-600 hover:bg-indigo-200 hover:text-indigo-800 transition-all duration-300 transform hover:scale-110"
                                >
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                  </svg>
                                </button>
                                <button
                                  onClick={() => handleDeleteMateria(materia.id)}
                                  className="p-2 bg-red-100 rounded-full text-red-600 hover:bg-red-200 hover:text-red-800 transition-all duration-300 transform hover:scale-110"
                                >
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                  </svg>
                                </button>
                              </div>
                            </div>
                          </div>
                        ))
                      }
                      {materias.filter(materia => 
                        (searchMateriaNombre === '' || 
                          materia.nombre.toLowerCase().includes(searchMateriaNombre.toLowerCase())) &&
                        (searchMateriaCodigo === '' || 
                          materia.codigo.toLowerCase().includes(searchMateriaCodigo.toLowerCase()))
                      ).length === 0 && (
                        <div className="col-span-3 py-6 text-center text-gray-500">
                          No se encontraron materias con los criterios de búsqueda especificados.
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}
              
              {/* Gestión de Alumnos */}
              {activeTab === 'alumnos' && (
                <div className="animate-fadeIn">
                  <div className="flex justify-between items-center mb-6">
                    <div className="flex items-center">
                      <div className="bg-blue-100 p-2 rounded-full mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                      </div>
                      <h3 className="text-xl font-bold text-gray-800 bg-gradient-to-r from-blue-600 to-blue-400 bg-clip-text text-transparent">Gestión de Alumnos</h3>
                    </div>
                    <button
                      onClick={() => {
                        setFormData({
                          nombre: '',
                          apellido: '',
                          cedula: 'N/P',
                          fechaNacimiento: '',
                          lugarNacimiento: '',
                          sexo: 'Otro',
                          ef: '',
                          edad: 0,
                          esMenorDeEdad: false,
                          modoEdicion: false
                        });
                        setShowStudentForm(true);
                      }}
                      className="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg shadow-md hover:from-blue-600 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg flex items-center"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                      </svg>
                      Agregar Alumno
                    </button>
                  </div>
                  
                  {/* Formulario de Agregar/Editar Alumno */}
                  {showStudentForm && (
                    <div className="bg-gradient-to-br from-blue-50 to-white p-6 rounded-lg shadow-md mb-6 border-t-4 border-blue-500 border-r border-b border-l border-blue-100 animate-fadeIn transition-all duration-300">
                      <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-bold text-blue-700 flex items-center">
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                          </svg>
                          {formData.modoEdicion ? 'Editar Alumno' : 'Agregar Nuevo Alumno'}
                        </h3>
                        <button 
                          onClick={() => setShowStudentForm(false)}
                          className="text-gray-500 hover:text-gray-700"
                          type="button"
                        >
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                          </svg>
                        </button>
                      </div>
                    <form onSubmit={(e) => formData.modoEdicion ? handleEditAlumno(e) : handleAddAlumno(e)}>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                          <label className="block text-sm font-medium text-blue-700 mb-1 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            Nombre
                          </label>
                          <div className="relative">
                            <input
                              type="text"
                              name="nombre"
                              value={formData.nombre || ''}
                              placeholder="Indique el nombre del alumno"
                              onChange={handleFormChange}
                              className="w-full pl-10 pr-3 py-2 bg-white border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                              required
                            />
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                              <span className="text-blue-500">Aa</span>
                            </div>
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-blue-700 mb-1 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            Apellido
                          </label>
                          <div className="relative">
                            <input
                              type="text"
                              name="apellido"
                              value={formData.apellido || ''}
                              placeholder="Indique el apellido del alumno"
                              onChange={handleFormChange}
                              className="w-full pl-10 pr-3 py-2 bg-white border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                              required
                            />
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                              <span className="text-blue-500">Aa</span>
                            </div>
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-blue-700 mb-1 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2" />
                            </svg>
                            Cédula
                          </label>
                          <div className="relative">
                            <input
                              type="text"
                              name="cedula"
                              value={formData.cedula || ''}
                              onChange={handleFormChange}
                              className="w-full pl-10 pr-3 py-2 bg-white border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                              placeholder="Indique la cedula, si no posee utiliza la del representante"
                            />
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                              <span className="text-blue-500">#</span>
                            </div>
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-blue-700 mb-1 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            Fecha de Nacimiento
                          </label>
                          <div className="relative">
                            <input
                              type="date"
                              name="fechaNacimiento"
                              value={formData.fechaNacimiento || ''}
                              onChange={handleFormChange}
                              className="w-full pl-10 pr-3 py-2 bg-white border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                              required
                            />
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                              <span className="text-blue-500">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                              </span>
                            </div>
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-blue-700 mb-1 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Lugar de Nacimiento
                          </label>
                          <div className="relative">
                            <select
                              name="lugarNacimiento"
                              value={formData.lugarNacimiento || ''}
                              onChange={handleFormChange}
                              className="w-full pl-10 pr-3 py-2 bg-white border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                            >
                              <option value="">Seleccione un estado</option>
                              <option value="Amazonas">Amazonas</option>
                              <option value="Anzoátegui">Anzoátegui</option>
                              <option value="Apure">Apure</option>
                              <option value="Aragua">Aragua</option>
                              <option value="Barinas">Barinas</option>
                              <option value="Bolívar">Bolívar</option>
                              <option value="Carabobo">Carabobo</option>
                              <option value="Cojedes">Cojedes</option>
                              <option value="Delta Amacuro">Delta Amacuro</option>
                              <option value="Distrito Capital">Distrito Capital</option>
                              <option value="Falcón">Falcón</option>
                              <option value="Guárico">Guárico</option>
                              <option value="Lara">Lara</option>
                              <option value="Mérida">Mérida</option>
                              <option value="Miranda">Miranda</option>
                              <option value="Monagas">Monagas</option>
                              <option value="Nueva Esparta">Nueva Esparta</option>
                              <option value="Portuguesa">Portuguesa</option>
                              <option value="Sucre">Sucre</option>
                              <option value="Táchira">Táchira</option>
                              <option value="Trujillo">Trujillo</option>
                              <option value="Vargas">Vargas</option>
                              <option value="Yaracuy">Yaracuy</option>
                              <option value="Zulia">Zulia</option>
                            </select>
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                              <span className="text-blue-500">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                </svg>
                              </span>
                            </div>
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-blue-700 mb-1 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            Sexo
                          </label>
                          <div className="relative">
                            <select
                              name="sexo"
                              value={formData.sexo || 'Otro'}
                              onChange={handleFormChange}
                              className="w-full pl-10 pr-3 py-2 bg-white border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                            >
                              <option value="M">Masculino</option>
                              <option value="F">Femenino</option>
                              <option value="Otro">Otro</option>
                            </select>
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                              <span className="text-blue-500">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                              </span>
                            </div>
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-blue-700 mb-1 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            EF (Información adicional)
                          </label>
                          <div className="relative">
                            <input
                              type="text"
                              name="ef"
                              value={formData.ef || ''}
                              placeholder="Información adicional del estudiante"
                              onChange={handleFormChange}
                              className="w-full pl-10 pr-3 py-2 bg-white border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                            />
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                              <span className="text-blue-500">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                              </span>
                            </div>
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-blue-700 mb-1 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Edad
                          </label>
                          <div className="flex items-center h-10 pl-10 pr-3 py-2 border border-blue-200 rounded-lg bg-white relative">
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                              <span className="text-blue-500 font-bold">+</span>
                            </div>
                            <span className="font-medium text-gray-700">{formData.edad || 0} años</span>
                          </div>
                        </div>
                      </div>
                      <div className="flex items-center p-3 mb-4 bg-blue-50 rounded-lg border border-blue-100 shadow-sm">
                        <div className={`mr-3 w-5 h-5 rounded-full flex items-center justify-center ${formData.esMenorDeEdad ? 'bg-amber-500' : 'bg-blue-500'}`}>
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-3 w-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                        </div>
                        <span className={`text-sm font-medium ${formData.esMenorDeEdad ? 'text-amber-700' : 'text-blue-700'}`}>
                          {formData.esMenorDeEdad ? 'Es menor de edad' : 'Es mayor de edad'}
                        </span>
                      </div>
                      <div className="flex justify-end space-x-4 mt-6">
                        <button
                          type="button"
                          onClick={() => {
                            // Limpiar el formulario
                            setFormData({
                              nombre: '',
                              apellido: '',
                              cedula: 'N/P',
                              fechaNacimiento: '',
                              lugarNacimiento: '',
                              sexo: 'Otro',
                              ef: '',
                              grupo: '',
                              edad: 0,
                              esMenorDeEdad: false,
                              modoEdicion: false
                            });
                            // Ocultar el formulario
                            setShowStudentForm(false);
                          }}
                          className="px-5 py-2 bg-white text-gray-700 rounded-lg border border-gray-300 shadow-sm hover:bg-gray-50 transition-all duration-300 flex items-center"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                          Cancelar
                        </button>
                        <button
                          type="submit"
                          className="px-5 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg flex items-center"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                          {formData.modoEdicion ? 'Guardar Cambios' : 'Agregar Alumno'}
                        </button>
                      </div>
                    </form>
                  </div>
                  )}
                  
                  {/* Filtrador avanzado para estudiantes */}
                  <div className="bg-gradient-to-br from-blue-50 to-white p-5 rounded-xl shadow-md mb-6 border-t-4 border-blue-500 border-r border-b border-l border-blue-100">
                    <h4 className="text-md font-bold text-blue-700 mb-4 flex items-center">
                      <svg className="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                      </svg>
                      Filtros de búsqueda avanzada
                    </h4>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="bg-white p-4 rounded-lg shadow-sm border border-blue-100 hover:shadow-md transition-all duration-300">
                        <label className="block text-sm font-medium text-blue-700 mb-2 flex items-center">
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                          </svg>
                          Buscar por nombre
                        </label>
                        <div className="relative">
                          <input
                            type="text"
                            placeholder="Nombre del estudiante..."
                            className="w-full pl-10 pr-4 py-2 bg-blue-50 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                            value={searchNombre}
                            onChange={(e) => setSearchNombre(e.target.value)}
                          />
                          <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg className="h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                              <path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd" />
                            </svg>
                          </div>
                        </div>
                      </div>
                      
                      <div className="bg-white p-4 rounded-lg shadow-sm border border-blue-100 hover:shadow-md transition-all duration-300">
                        <label className="block text-sm font-medium text-blue-700 mb-2 flex items-center">
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2" />
                          </svg>
                          Buscar por cédula
                        </label>
                        <div className="relative">
                          <input
                            type="text"
                            placeholder="Número de cédula..."
                            className="w-full pl-10 pr-4 py-2 bg-blue-50 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                            value={searchCedula}
                            onChange={(e) => setSearchCedula(e.target.value)}
                          />
                          <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span className="text-blue-500 font-bold">#</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div className="flex justify-end mt-5">
                      <button
                        onClick={() => {
                          setSearchNombre('');
                          setSearchCedula('');
                        }}
                        className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-all duration-300 text-sm font-medium flex items-center shadow-sm hover:shadow transform hover:-translate-y-1"
                      >
                        <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Limpiar todos los filtros
                      </button>
                    </div>
                  </div>
                  
                  <div className="overflow-x-auto bg-white rounded-xl shadow-md border border-blue-100 mt-6">
                    <table className="min-w-full divide-y divide-blue-200 table-fixed">
                      <thead className="bg-gradient-to-r from-blue-600 to-blue-500">
                        <tr>
                          <th scope="col" className="w-1/6 px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">
                            <div className="flex items-center">
                              <span className="bg-white text-green-600 rounded-full w-6 h-6 inline-flex items-center justify-center mr-2 shadow-sm">#</span>
                              Cédula
                            </div>
                          </th>
                          <th scope="col" className="w-2/6 px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">
                            <div className="flex items-center">
                              <span className="bg-white text-green-600 rounded-full w-6 h-6 inline-flex items-center justify-center mr-2 shadow-sm">Aa</span>
                              Nombre
                            </div>
                          </th>
                          <th scope="col" className="w-1/6 px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">
                            <div className="flex items-center">
                              <span className="bg-white text-green-600 rounded-full w-6 h-6 inline-flex items-center justify-center mr-2 shadow-sm">+</span>
                              Edad
                            </div>
                          </th>
                          <th scope="col" className="w-1/6 px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider hidden">
                            <div className="flex items-center">
                              <span className="bg-white text-green-600 rounded-full w-6 h-6 inline-flex items-center justify-center mr-2 shadow-sm">👥</span>
                              Grupo
                            </div>
                          </th>
                          <th scope="col" className="w-1/6 px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">
                            <div className="flex items-center">
                              <span className="bg-white text-green-600 rounded-full w-6 h-6 inline-flex items-center justify-center mr-2 shadow-sm">?</span>
                              Es menor de edad
                            </div>
                          </th>
                          <th scope="col" className="w-1/6 px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">
                            <div className="flex items-center">
                              <span className="bg-white text-green-600 rounded-full w-6 h-6 inline-flex items-center justify-center mr-2 shadow-sm">🔄</span>
                              Estado
                            </div>
                          </th>
                          <th scope="col" className="w-1/6 px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">
                            <div className="flex items-center">
                              <span className="bg-white text-green-600 rounded-full w-6 h-6 inline-flex items-center justify-center mr-2 shadow-sm">⚙️</span>
                              Acciones
                            </div>
                          </th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-gray-200">
                        {alumnos.length === 0 ? (
                          <tr>
                            <td colSpan="5" className="px-6 py-10 text-center">
                              <div className="flex flex-col items-center justify-center">
                                <div className="bg-blue-100 p-3 rounded-full mb-3">
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                  </svg>
                                </div>
                                <h3 className="text-lg font-medium text-gray-900 mb-1">No hay alumnos registrados</h3>
                                <p className="text-sm text-gray-500 mb-4">Agrega un nuevo alumno usando el botón en la parte superior.</p>
                                <button
                                  onClick={() => {
                                    setFormData({
                              nombre: '',
                              cedula: 'N/P',
                              fechaNacimiento: '',
                              lugarNacimiento: '',
                              sexo: 'Otro',
                              ef: '',
                              grupo: '',
                              edad: 0,
                              esMenorDeEdad: false,
                              modoEdicion: false
                            });
                                    setShowStudentForm(true);
                                  }}
                                  className="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg flex items-center"
                                >
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                  </svg>
                                  Agregar Alumno
                                </button>
                              </div>
                            </td>
                          </tr>
                        ) : (
                          (() => {
                            const alumnosFiltrados = alumnos.filter(alu => {
                              // Filtrar por nombre si hay búsqueda de nombre
                              const nombreMatch = !searchNombre || 
                                (alu.nombre && alu.nombre.toLowerCase().includes(searchNombre.toLowerCase()));
                              
                              // Filtrar por cédula si hay búsqueda de cédula
                              const cedulaMatch = !searchCedula || 
                                (alu.cedula && alu.cedula.toLowerCase().includes(searchCedula.toLowerCase()));
                              
                              // Compatibilidad con el filtro anterior
                              const searchTermMatch = !searchTerm || 
                                (alu.cedula && alu.cedula.toLowerCase().includes(searchTerm.toLowerCase())) ||
                                (alu.nombre && alu.nombre.toLowerCase().includes(searchTerm.toLowerCase()));
                              
                              // Devolver true solo si cumple con todos los filtros activos
                              return nombreMatch && cedulaMatch && searchTermMatch;
                            });

                            if (alumnosFiltrados.length === 0) {
                              return (
                                <tr>
                                  <td colSpan="5" className="px-6 py-10 text-center">
                                    <div className="flex flex-col items-center justify-center">
                                      <div className="bg-amber-100 p-3 rounded-full mb-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16l2.879-2.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                      </div>
                                      <h3 className="text-lg font-medium text-gray-900 mb-1">No se encontraron alumnos</h3>
                                      <p className="text-sm text-gray-500 mb-4">No hay alumnos que coincidan con los criterios de búsqueda.</p>
                                      <button
                                        onClick={() => {
                                          setSearchNombre('');
                                          setSearchCedula('');
                                        }}
                                        className="px-4 py-2 bg-amber-600 text-white rounded-lg shadow-md hover:bg-amber-700 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg flex items-center"
                                      >
                                        <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                        Limpiar filtros
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                              );
                            }

                            return alumnosFiltrados.map((alumno, index) => {
                              // Calcular la edad si no está ya calculada
                              const edad = alumno.edad || calcularEdad(alumno.fechaNacimiento);
                              const esMenorDeEdad = alumno.esMenorDeEdad !== undefined ? alumno.esMenorDeEdad : edad < 18;
                            
                            return (
                              <tr key={alumno.id || alumno._id} className={`${index % 2 === 0 ? 'bg-white' : 'bg-blue-50'} hover:bg-blue-100 transition-colors duration-150 transform hover:scale-[1.01] card-animate card-animate-delay-${index % 3 + 1}`}>
                                <td className="px-6 py-4 whitespace-nowrap text-sm">
                                  <div className="flex items-center justify-start">
                                    {alumno.cedula === 'N/P' ? 
                                      <span className="text-gray-400 italic bg-gray-100 px-2 py-1 rounded-md">N/P</span> : 
                                      <span className="font-medium text-gray-800 bg-blue-100 px-3 py-1 rounded-full">{alumno.cedula}</span>
                                    }
                                  </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap">
                                  <div className="flex items-center">
                                    <div className="flex-shrink-0 h-8 w-8 bg-blue-200 rounded-full flex items-center justify-center text-blue-600 font-bold">
                                      {alumno.nombre.charAt(0).toUpperCase()}
                                    </div>
                                    <div className="ml-3">
                                      <p className="text-sm font-medium text-gray-800">{alumno.nombre} {alumno.apellido || ''}</p>
                                      <div className="flex flex-col space-y-1 mt-1">
                                        {alumno.lugarNacimiento && (
                                          <p className="text-xs text-gray-500">Lugar: {alumno.lugarNacimiento}</p>
                                        )}
                                        {alumno.sexo && (
                                          <p className="text-xs text-gray-500">
                                            <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                              Sexo: {alumno.sexo === 'M' ? 'Masculino' : alumno.sexo === 'F' ? 'Femenino' : 'Otro'}
                                            </span>
                                          </p>
                                        )}
                                        {alumno.ef && (
                                          <p className="text-xs text-gray-500">EF: {alumno.ef}</p>
                                        )}
                                      </div>
                                    </div>
                                  </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap">
                                  <div className="flex items-center">
                                    <span className="px-3 py-1 inline-flex text-sm leading-5 font-medium rounded-full bg-blue-100 text-blue-800">
                                      {edad} años
                                    </span>
                                  </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap hidden">
                                  <div className="flex items-center">
                                    {alumno.grupo ? (
                                      <span className="px-3 py-1 inline-flex text-sm leading-5 font-medium rounded-full bg-green-100 text-green-800">
                                        {alumno.grupo}
                                      </span>
                                    ) : (
                                      <span className="px-3 py-1 inline-flex text-sm leading-5 font-medium rounded-full bg-gray-100 text-gray-500 italic">
                                        Sin grupo
                                      </span>
                                    )}
                                  </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm">
                                  <div className="flex items-center">
                                    <span className={`px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${esMenorDeEdad ? 'bg-amber-100 text-amber-800' : 'bg-blue-100 text-blue-800'}`}>
                                      <div className={`w-3 h-3 rounded-full mr-2 ${esMenorDeEdad ? 'bg-amber-500' : 'bg-blue-500'}`}></div>
                                      {esMenorDeEdad ? 'Sí' : 'No'}
                                    </span>
                                  </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm">
                                  <div className="flex items-center justify-center">
                                    <button 
                                      onClick={() => handleEstadoChange(alumno.id || alumno._id, alumno.estado !== undefined ? alumno.estado : 1)}
                                      disabled={updatingEstado}
                                      className="relative inline-flex items-center h-6 rounded-full w-11 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                      style={{ backgroundColor: alumno.estado === 0 ? '#d1d5db' : '#3b82f6' }}
                                    >
                                      <span className="sr-only">Cambiar estado</span>
                                      <span 
                                        className={`${alumno.estado === 0 ? 'translate-x-1' : 'translate-x-6'} inline-block w-4 h-4 transform bg-white rounded-full transition-transform`}
                                      />
                                    </button>
                                    <span className="ml-2 text-xs font-medium text-gray-700">
                                      {alumno.estado === 0 ? 'Inactivo' : 'Activo'}
                                    </span>
                                  </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                  <div className="flex space-x-2 justify-center">
                                    <button
                                      onClick={() => {
                                        // Cargar los datos del alumno en el formulario
                                        setFormData({
                                          id: alumno.id || alumno._id,
                                          nombre: alumno.nombre,
                                          cedula: alumno.cedula,
                                          fechaNacimiento: alumno.fechaNacimiento,
                                          edad: edad,
                                          esMenorDeEdad: esMenorDeEdad,
                                          modoEdicion: true
                                        });
                                        // Mostrar el formulario
                                        setShowStudentForm(true);
                                        // Hacer scroll hacia arriba para ver el formulario
                                        window.scrollTo({ top: 0, behavior: 'smooth' });
                                      }}
                                      className="p-2 bg-blue-100 rounded-full text-blue-600 hover:bg-blue-200 hover:text-blue-800 transition-all duration-300 transform hover:scale-110"
                                    >
                                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                      </svg>
                                    </button>
                                    <button
                                      onClick={() => handleDeleteAlumno(alumno.id || alumno._id)}
                                      className="p-2 bg-red-100 rounded-full text-red-600 hover:bg-red-200 hover:text-red-800 transition-all duration-300 transform hover:scale-110"
                                    >
                                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                      </svg>
                                    </button>
                                  </div>
                                </td>
                              </tr>
                            );
                          })
                          })()
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
              


              {/* Asignaciones y Calificaciones */}
              {activeTab === 'asignaciones' && (
                <div className="animate-fadeIn">
                  <div className="flex justify-between items-center mb-6">
                    <div className="flex items-center">
                      <div className="bg-blue-100 p-2 rounded-full mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                      </div>
                      <h3 className="text-xl font-bold text-gray-800 bg-gradient-to-r from-blue-600 to-blue-400 bg-clip-text text-transparent">Gestión de Asignaciones</h3>
                    </div>
                    <button
                      onClick={() => setShowAsignacionForm(!showAsignacionForm)}
                      className="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg shadow-md hover:from-blue-600 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg flex items-center"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                      </svg>
                      {showAsignacionForm ? 'Cancelar' : 'Agregar Asignación'}
                    </button>
                  </div>
                  
                  {/* Formulario de asignación */}
                  {showAsignacionForm && (
                    <div className="bg-white shadow-md rounded-lg p-4 mb-4">
                      <h3 className="text-lg font-semibold mb-2">
                        {asignacionFormData.modoEdicion ? 'Editar Asignación' : 'Nueva Asignación'}
                      </h3>
                      <form onSubmit={asignacionFormData.modoEdicion ? handleEditAsignacion : handleAddAsignacion}>
                        {/* Se eliminó la selección de materia ya que ahora se crearán automáticamente todas las materias del año seleccionado */}
                        <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Profesor
                          </label>
                          <select
                            name="profesorId"
                            value={asignacionFormData.profesorId}
                            onChange={handleAsignacionFormChange}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                            required
                          >
                            <option key="select-profesor" value="">Seleccione un profesor</option>
                            {profesores && profesores.length > 0 ? profesores.map((profesor) => {
                              // Asegurar que cada opción tenga una clave única
                              const uniqueKey = profesor._id ? profesor._id.toString() : `profesor-${profesor.nombre}`;
                              const profesorId = profesor._id || profesor.id;
                              return (
                                <option key={uniqueKey} value={profesorId || ''}>
                                  {profesor.nombre} {profesor.apellido || ''}
                                </option>
                              );
                            }) : null}
                          </select>
                        </div>
                        <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Año
                          </label>
                          <select
                            name="anio"
                            value={asignacionFormData.anio || '1 año'}
                            onChange={handleAsignacionFormChange}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                            required
                          >
                            <option value="1 año">1 año</option>
                            <option value="2 año">2 año</option>
                            <option value="3 año">3 año</option>
                            <option value="4 año">4 año</option>
                            <option value="5 año">5 año</option>
                          </select>
                        </div>
                        <div className="mb-6">
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Periodo Académico
                          </label>
                          
                          <div className="bg-gray-50 rounded-lg p-4 border border-gray-200 shadow-sm">
                            <div className="flex flex-col sm:flex-row gap-4 mb-3">
                              {/* Opción 1: Entrada libre */}
                              <div 
                                className={`flex-1 p-3 rounded-lg border-2 cursor-pointer transition-all ${!asignacionFormData.usarPeriodoExistente 
                                  ? 'border-blue-500 bg-blue-50' 
                                  : 'border-gray-200 hover:border-blue-300'}`}
                                onClick={() => setAsignacionFormData(prev => ({ ...prev, usarPeriodoExistente: false }))}
                              >
                                <div className="flex items-center">
                                  <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${!asignacionFormData.usarPeriodoExistente ? 'border-blue-600' : 'border-gray-400'}`}>
                                    {!asignacionFormData.usarPeriodoExistente && (
                                      <div className="w-3 h-3 rounded-full bg-blue-600"></div>
                                    )}
                                  </div>
                                  <label htmlFor="periodoLibre" className="ml-2 block text-sm font-medium cursor-pointer">
                                    Entrada manual
                                  </label>
                                </div>
                                <p className="text-xs text-gray-500 mt-1 ml-7">Ingrese un nuevo periodo académico</p>
                              </div>
                              
                              {/* Opción 2: Seleccionar existente */}
                              <div 
                                className={`flex-1 p-3 rounded-lg border-2 cursor-pointer transition-all ${asignacionFormData.usarPeriodoExistente 
                                  ? 'border-blue-500 bg-blue-50' 
                                  : 'border-gray-200 hover:border-blue-300'}`}
                                onClick={() => setAsignacionFormData(prev => ({ ...prev, usarPeriodoExistente: true }))}
                              >
                                <div className="flex items-center">
                                  <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${asignacionFormData.usarPeriodoExistente ? 'border-blue-600' : 'border-gray-400'}`}>
                                    {asignacionFormData.usarPeriodoExistente && (
                                      <div className="w-3 h-3 rounded-full bg-blue-600"></div>
                                    )}
                                  </div>
                                  <label htmlFor="periodoExistente" className="ml-2 block text-sm font-medium cursor-pointer">
                                    Seleccionar existente
                                  </label>
                                </div>
                                <p className="text-xs text-gray-500 mt-1 ml-7">Use un periodo ya registrado en el sistema</p>
                              </div>
                            </div>
                            
                            {/* Campo de entrada según la opción seleccionada */}
                            <div className="mt-3">
                              {asignacionFormData.usarPeriodoExistente ? (
                                <div className="relative">
                                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg className="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                      <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clipRule="evenodd" />
                                    </svg>
                                  </div>
                                  <select
                                    name="periodo"
                                    value={asignacionFormData.periodo || ''}
                                    onChange={handleAsignacionFormChange}
                                    className="w-full pl-10 pr-3 py-2.5 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                  >
                                    <option value="">Seleccione un periodo</option>
                                    {/* Obtener periodos únicos de las asignaciones existentes */}
                                    {[...new Set(asignaciones
                                      .filter(a => a.periodo && a.periodo.trim() !== '')
                                      .map(a => a.periodo))]
                                      .sort()
                                      .map((periodo, index) => (
                                        <option key={`periodo-${index}`} value={periodo}>
                                          {periodo}
                                        </option>
                                      ))}
                                  </select>
                                </div>
                              ) : (
                                <div className="relative">
                                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg className="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                      <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd" />
                                    </svg>
                                  </div>
                                  <input
                                    type="text"
                                    name="periodo"
                                    value={asignacionFormData.periodo || ''}
                                    onChange={handleAsignacionFormChange}
                                    placeholder="Ej: 2025-1, Primer Semestre 2025"
                                    className="w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                  />
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                        <div className="mb-6">
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Alumnos
                          </label>
                          
                          <div className="bg-gray-50 rounded-lg p-4 border border-gray-200 shadow-sm">
                            {/* Campo de búsqueda para filtrar alumnos */}
                            <div className="mb-3">
                              <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                  <svg className="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd" />
                                  </svg>
                                </div>
                                <input
                                  type="text"
                                  placeholder="Buscar por nombre o cédula..."
                                  className="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-colors"
                                  value={searchAlumno}
                                  onChange={(e) => setSearchAlumno(e.target.value)}
                                />
                              </div>
                            </div>
                            
                            {/* Lista de alumnos disponibles */}
                            <div className="border border-gray-300 rounded-md overflow-hidden bg-white shadow-sm">
                              <div className="p-1 max-h-60 overflow-y-auto">
                                {alumnos
                                  .filter(alumno => 
                                    alumno.nombre.toLowerCase().includes(searchAlumno.toLowerCase()) ||
                                    (alumno.cedula && alumno.cedula.toLowerCase().includes(searchAlumno.toLowerCase()))
                                  )
                                  .map((alumno) => {
                                    // Verificar si el alumno ya está seleccionado
                                    const isSelected = asignacionFormData.alumnos.some(
                                      selectedId => selectedId === alumno._id || selectedId === alumno.id
                                    );
                                    
                                    return (
                                      <div 
                                        key={alumno._id || alumno.id} 
                                        className={`flex items-center p-2.5 hover:bg-gray-50 cursor-pointer transition-colors ${isSelected ? 'bg-blue-50 hover:bg-blue-100' : ''}`}
                                        onClick={() => {
                                          // Alternar selección del alumno
                                          const alumnoId = alumno._id || alumno.id;
                                          const updatedAlumnos = isSelected
                                            ? asignacionFormData.alumnos.filter(id => id !== alumnoId)
                                            : [...asignacionFormData.alumnos, alumnoId];
                                          
                                          setAsignacionFormData({
                                            ...asignacionFormData,
                                            alumnos: updatedAlumnos
                                          });
                                        }}
                                      >
                                        <div className={`w-5 h-5 rounded border-2 flex items-center justify-center ${isSelected ? 'bg-blue-500 border-blue-500' : 'border-gray-300'}`}>
                                          {isSelected && (
                                            <svg className="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                              <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"></path>
                                            </svg>
                                          )}
                                        </div>
                                        <div className="ml-3">
                                          <p className="text-sm font-medium text-gray-900">{alumno.nombre} {alumno.apellido}</p>
                                          <p className="text-xs text-gray-500">{alumno.cedula || 'Sin cédula'}</p>
                                        </div>
                                      </div>
                                    );
                                  })}
                              </div>
                            </div>
                            
                            {/* Contador de alumnos seleccionados */}
                            <div className="mt-3 flex items-center">
                              <div className="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full">
                                {asignacionFormData.alumnos.length} alumno(s) seleccionado(s)
                              </div>
                              {asignacionFormData.alumnos.length > 0 && (
                                <button 
                                  type="button" 
                                  onClick={() => setAsignacionFormData({...asignacionFormData, alumnos: []})}
                                  className="ml-2 text-xs text-gray-500 hover:text-red-500 transition-colors"
                                >
                                  Limpiar selección
                                </button>
                              )}
                            </div>
                          </div>
                        </div>
                        <div className="flex justify-end space-x-2">
                          <button
                            type="button"
                            onClick={() => {
                              setShowAsignacionForm(false);
                              setAsignacionFormData({
                                materiaId: '',
                                profesorId: '',
                                alumnos: [],
                                modoEdicion: false
                              });
                            }}
                            className="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                          >
                            Cancelar
                          </button>
                          <button
                            type="submit"
                            className="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                          >
                            {asignacionFormData.modoEdicion ? 'Actualizar' : 'Guardar'}
                          </button>
                        </div>
                      </form>
                    </div>
                  )}
                  
                  {/* Filtros de búsqueda avanzada */}
                  <div className="bg-gradient-to-br from-blue-50 to-white p-5 rounded-xl shadow-md mb-6 border-t-4 border-blue-500 border-r border-b border-l border-blue-100">
                    <h4 className="text-md font-bold text-blue-700 mb-4 flex items-center">
                      <svg className="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                      </svg>
                      Filtros de búsqueda avanzada
                    </h4>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="bg-white p-4 rounded-lg shadow-sm border border-blue-100 hover:shadow-md transition-all duration-300">
                        <label className="block text-sm font-medium text-blue-700 mb-2 flex items-center">
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                          </svg>
                          Filtrar por período
                        </label>
                        <div className="relative">
                          <select
                            id="searchPeriodo"
                            className="w-full pl-10 pr-4 py-2 bg-blue-50 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                            value={searchPeriodo}
                            onChange={(e) => setSearchPeriodo(e.target.value)}
                          >
                            <option value="">Todos los períodos</option>
                            {[...new Set(asignaciones
                              .filter(a => a.periodo && a.periodo.trim() !== '')
                              .map(a => a.periodo))]
                              .sort()
                              .map((periodo, index) => (
                                <option key={`periodo-${index}`} value={periodo}>
                                  {periodo}
                                </option>
                              ))}
                          </select>
                          <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg className="h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                              <path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd" />
                            </svg>
                          </div>
                        </div>
                      </div>
                      
                      <div className="bg-white p-4 rounded-lg shadow-sm border border-blue-100 hover:shadow-md transition-all duration-300">
                        <label className="block text-sm font-medium text-blue-700 mb-2 flex items-center">
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                          </svg>
                          Filtrar por año
                        </label>
                        <div className="relative">
                          <select
                            className="w-full pl-10 pr-4 py-2 bg-blue-50 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                            value={searchAnio}
                            onChange={(e) => setSearchAnio(e.target.value)}
                          >
                            <option value="">Todos los años</option>
                            <option value="1 año">1 año</option>
                            <option value="2 año">2 año</option>
                            <option value="3 año">3 año</option>
                            <option value="4 año">4 año</option>
                            <option value="5 año">5 año</option>
                          </select>
                          <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg className="h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z" />
                            </svg>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div className="flex justify-end mt-5">
                      <button
                        onClick={() => {
                          setSearchPeriodo('');
                          setSearchAnio('');
                        }}
                        className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-all duration-300 text-sm font-medium flex items-center shadow-sm hover:shadow transform hover:-translate-y-1"
                      >
                        <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Limpiar filtros
                      </button>
                    </div>
                  </div>
                  
                  {/* Tabla de asignaciones */}
                  <div className="overflow-x-auto bg-white rounded-xl shadow-md border border-blue-100 mt-6">
                    <table className="min-w-full divide-y divide-blue-200 table-fixed">
                      <thead className="bg-gradient-to-r from-blue-600 to-blue-500">
                        <tr>
                          <th scope="col" className="w-1/6 px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">
                            <div className="flex items-center">
                              <span className="bg-white text-blue-600 rounded-full w-6 h-6 inline-flex items-center justify-center mr-2 shadow-sm">📚</span>
                              Materia
                            </div>
                          </th>
                          <th scope="col" className="w-1/6 px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">
                            <div className="flex items-center">
                              <span className="bg-white text-blue-600 rounded-full w-6 h-6 inline-flex items-center justify-center mr-2 shadow-sm">👨‍🏫</span>
                              Profesor
                            </div>
                          </th>
                          <th scope="col" className="w-1/6 px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">
                            <div className="flex items-center">
                              <span className="bg-white text-blue-600 rounded-full w-6 h-6 inline-flex items-center justify-center mr-2 shadow-sm">🗓️</span>
                              Periodo
                            </div>
                          </th>
                          <th scope="col" className="w-1/12 px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">
                            <div className="flex items-center">
                              <span className="bg-white text-blue-600 rounded-full w-6 h-6 inline-flex items-center justify-center mr-2 shadow-sm">📅</span>
                              Año
                            </div>
                          </th>
                          <th scope="col" className="w-1/12 px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">
                            <div className="flex items-center">
                              <span className="bg-white text-blue-600 rounded-full w-6 h-6 inline-flex items-center justify-center mr-2 shadow-sm">👥</span>
                              Alumnos
                            </div>
                          </th>
                          <th scope="col" className="w-1/12 px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">
                            <div className="flex items-center">
                              <span className="bg-white text-blue-600 rounded-full w-6 h-6 inline-flex items-center justify-center mr-2 shadow-sm">📝</span>
                              Actividades
                            </div>
                          </th>
                          <th scope="col" className="w-1/6 px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">
                            <div className="flex items-center">
                              <span className="bg-white text-blue-600 rounded-full w-6 h-6 inline-flex items-center justify-center mr-2 shadow-sm">⚙️</span>
                              Acciones
                            </div>
                          </th>
                        </tr>
                      </thead>
                       <tbody className="bg-white divide-y divide-blue-200">
                        {Array.isArray(asignaciones) && asignaciones.length > 0
                          ? asignaciones
                            .filter(asignacion => {
                              // Filtrar por periodo si se ha seleccionado uno
                              if (searchPeriodo && asignacion.periodo !== searchPeriodo) {
                                return false;
                              }
                              // Filtrar por año si se ha seleccionado uno
                              if (searchAnio && asignacion.anio !== searchAnio) {
                                return false;
                              }
                              return true;
                            })
                            .map((asignacion, index) => {
                              const materia = materias.find(m => m.id === asignacion.materiaId || m._id === asignacion.materiaId);
                              const profesor = profesores.find(p => p.id === asignacion.profesorId || p._id === asignacion.profesorId);
                              
                              return (
                                <tr key={asignacion.id || asignacion._id} className={`${index % 2 === 0 ? 'bg-white' : 'bg-blue-50'} hover:bg-blue-100 transition-colors duration-150 transform hover:scale-[1.01] card-animate card-animate-delay-${index % 3 + 1}`}>
                                  <td className="px-6 py-4 whitespace-nowrap">
                                    <div className="flex items-center">
                                      <div className="flex-shrink-0 h-8 w-8 bg-blue-200 rounded-full flex items-center justify-center text-blue-600 font-bold">
                                        {materia ? materia.nombre.charAt(0).toUpperCase() : 'M'}
                                      </div>
                                      <div className="ml-3">
                                        <p className="text-sm font-medium text-gray-800">
                                          {asignacion.materiaNombre ? asignacion.materiaNombre : (materia ? `${materia.codigo ? materia.codigo + ' - ' : ''}${materia.nombre}` : 'N/A')}
                                        </p>
                                      </div>
                                    </div>
                                  </td>
                                  <td className="px-6 py-4 whitespace-nowrap">
                                    <div className="flex items-center">
                                      <div className="flex-shrink-0 h-8 w-8 bg-indigo-200 rounded-full flex items-center justify-center text-indigo-600 font-bold">
                                        {profesor ? profesor.nombre.charAt(0).toUpperCase() : 'P'}
                                      </div>
                                      <div className="ml-3 relative group">
                                        <p className="text-sm font-medium text-gray-800 group-hover:text-blue-600 cursor-pointer flex items-center">
                                          {asignacion.profesorNombre ? asignacion.profesorNombre : (profesor ? `${profesor.nombre} ${profesor.apellido || ''}` : 'N/A')}
                                          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 ml-1 text-gray-400 group-hover:text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                          </svg>
                                        </p>
                                        <div className="hidden group-hover:block absolute z-10 mt-1 w-56 bg-white rounded-md shadow-lg p-2 border border-gray-200">
                                          <p className="text-xs text-gray-500 mb-2">Cambiar profesor:</p>
                                          <select 
                                            className="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            onChange={(e) => handleChangeProfesor(asignacion.id || asignacion._id, e.target.value)}
                                            value={asignacion.profesorId || ''}
                                          >
                                            <option value="">Seleccionar profesor</option>
                                            {profesores.map(prof => (
                                              <option 
                                                key={prof._id || prof.id} 
                                                value={prof._id || prof.id}
                                              >
                                                {prof.nombre} {prof.apellido || ''}
                                              </option>
                                            ))}
                                          </select>
                                        </div>
                                      </div>
                                    </div>
                                  </td>
                                  <td className="px-6 py-4 whitespace-nowrap">
                                    <div className="flex items-center">
                                      <span className="px-3 py-1 inline-flex text-sm leading-5 font-medium rounded-full bg-blue-100 text-blue-800">
                                        {asignacion.periodo || 'No especificado'}
                                      </span>
                                    </div>
                                  </td>
                                  <td className="px-6 py-4 whitespace-nowrap">
                                    <div className="flex items-center">
                                      <span className="px-3 py-1 inline-flex text-sm leading-5 font-medium rounded-full bg-green-100 text-green-800">
                                        {asignacion.anio || '1 año'}
                                      </span>
                                    </div>
                                  </td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm">
                                    <div className="flex items-center justify-center">
                                      <span className="px-3 py-1 inline-flex text-sm leading-5 font-medium rounded-full bg-blue-100 text-blue-800">
                                        {asignacion.alumnosInfo ? asignacion.alumnosInfo.length : (asignacion.alumnos ? asignacion.alumnos.length : 0)}
                                      </span>
                                    </div>
                                  </td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm">
                                    <div className="flex items-center justify-center">
                                      <span className="px-3 py-1 inline-flex text-sm leading-5 font-medium rounded-full bg-blue-100 text-blue-800">
                                        {asignacion.actividades ? asignacion.actividades.length : 0}
                                      </span>
                                    </div>
                                  </td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div className="flex space-x-2 justify-center">
                                      <button
                                        onClick={() => {
                                          console.log('Editando asignación:', asignacion);
                                          // Obtener la materia y el profesor para mostrarlos en el formulario
                                          const materia = materias.find(m => m.id === asignacion.materiaId || m._id === asignacion.materiaId);
                                          const profesor = profesores.find(p => p.id === asignacion.profesorId || p._id === asignacion.profesorId);
                                          
                                          // Mostrar información de depuración
                                          console.log('Materia encontrada:', materia);
                                          console.log('Profesor encontrado:', profesor);
                                          console.log('Alumnos en la asignación:', asignacion.alumnos);
                                          console.log('AlumnosInfo en la asignación:', asignacion.alumnosInfo);
                                          
                                          // Asegurar que los IDs de alumnos sean strings
                                          let alumnosArray = [];
                                          if (asignacion.alumnos && asignacion.alumnos.length > 0) {
                                            alumnosArray = asignacion.alumnos.map(alumnoId => {
                                              // Convertir a string si es un objeto
                                              if (typeof alumnoId === 'object' && alumnoId !== null) {
                                                return alumnoId._id?.toString() || alumnoId.id?.toString() || '';
                                              }
                                              return alumnoId.toString();
                                            }).filter(id => id); // Eliminar IDs vacíos
                                          }
                                          
                                          // Asegurar que alumnosInfo esté correctamente formateado
                                          let alumnosInfoArray = [];
                                          if (asignacion.alumnosInfo && asignacion.alumnosInfo.length > 0) {
                                            alumnosInfoArray = asignacion.alumnosInfo.map(info => {
                                              // Asegurar que cada objeto tenga la estructura correcta
                                              if (typeof info === 'object' && info !== null) {
                                                return {
                                                  id: info.id || info._id || '',
                                                  nombre: info.nombre || 'Sin nombre',
                                                  idU: info.idU || 'N/P',
                                                  cedula: info.cedula || info.idU || 'N/A'
                                                };
                                              }
                                              return null;
                                            }).filter(info => info !== null); // Eliminar entradas nulas
                                          }
                                          
                                          // Preparar los nombres para mostrar
                                          const materiaNombre = asignacion.materiaNombre || (materia ? `${materia.codigo ? materia.codigo + ' - ' : ''}${materia.nombre}` : 'Materia sin nombre');
                                          const profesorNombre = asignacion.profesorNombre || (profesor ? `${profesor.nombre} ${profesor.apellido || ''}` : 'Profesor sin nombre');
                                          
                                          setAsignacionFormData({
                                            id: asignacion.id || asignacion._id,
                                            materiaId: asignacion.materiaId,
                                            materiaNombre: materiaNombre,
                                            profesorId: asignacion.profesorId,
                                            profesorNombre: profesorNombre,
                                            periodo: asignacion.periodo || '',
                                            anio: asignacion.anio || '1 año',
                                            alumnos: alumnosArray,
                                            alumnosInfo: alumnosInfoArray,
                                            modoEdicion: true
                                          });
                                          setShowAsignacionForm(true);
                                        }}
                                        className="p-2 bg-blue-100 rounded-full text-blue-600 hover:bg-blue-200 hover:text-blue-800 transition-all duration-300 transform hover:scale-110"
                                      >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                      </button>
                                      <button
                                        onClick={() => {
                                          // Redirigir a la página de calificaciones con el ID de la asignación
                                          const asignacionId = asignacion.id || asignacion._id;
                                          window.location.href = `/calificaciones?id=${asignacionId}`;
                                        }}
                                        className="p-2 bg-green-100 rounded-full text-green-600 hover:bg-green-200 hover:text-green-800 transition-all duration-300 transform hover:scale-110"
                                      >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                      </button>
                                      <button
                                        onClick={() => handleDeleteAsignacion(asignacion.id || asignacion._id)}
                                        className="p-2 bg-red-100 rounded-full text-red-600 hover:bg-red-200 hover:text-red-800 transition-all duration-300 transform hover:scale-110"
                                      >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                              );
                            })
                                    <span className="px-3 py-1 inline-flex text-sm leading-5 font-medium rounded-full bg-blue-100 text-blue-800">
                                      {asignacion.periodo || 'No especificado'}
                                    </span>
                                  </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap">
                                  <div className="flex items-center">
                                    <span className="px-3 py-1 inline-flex text-sm leading-5 font-medium rounded-full bg-green-100 text-green-800">
                                      {asignacion.anio || '1 año'}
                                    </span>
                                  </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm">
                                  <div className="flex items-center justify-center">
                                    <span className="px-3 py-1 inline-flex text-sm leading-5 font-medium rounded-full bg-blue-100 text-blue-800">
                                      {asignacion.alumnosInfo ? asignacion.alumnosInfo.length : (asignacion.alumnos ? asignacion.alumnos.length : 0)}
                                    </span>
                                  </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm">
                                  <div className="flex items-center justify-center">
                                    <span className="px-3 py-1 inline-flex text-sm leading-5 font-medium rounded-full bg-blue-100 text-blue-800">
                                      {asignacion.actividades ? asignacion.actividades.length : 0}
                                    </span>
                                  </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                  <div className="flex space-x-2 justify-center">
                                    <button
                                      onClick={() => {
                                        console.log('Editando asignación:', asignacion);
                                        // Obtener la materia y el profesor para mostrarlos en el formulario
                                        const materia = materias.find(m => m.id === asignacion.materiaId || m._id === asignacion.materiaId);
                                        const profesor = profesores.find(p => p.id === asignacion.profesorId || p._id === asignacion.profesorId);
                                        
                                        // Mostrar información de depuración
                                        console.log('Materia encontrada:', materia);
                                        console.log('Profesor encontrado:', profesor);
                                        console.log('Alumnos en la asignación:', asignacion.alumnos);
                                        console.log('AlumnosInfo en la asignación:', asignacion.alumnosInfo);
                                        
                                        // Asegurar que los IDs de alumnos sean strings
                                        let alumnosArray = [];
                                        if (asignacion.alumnos && asignacion.alumnos.length > 0) {
                                          alumnosArray = asignacion.alumnos.map(alumnoId => {
                                            // Convertir a string si es un objeto
                                            if (typeof alumnoId === 'object' && alumnoId !== null) {
                                              return alumnoId._id?.toString() || alumnoId.id?.toString() || '';
                                            }
                                            return alumnoId.toString();
                                          }).filter(id => id); // Eliminar IDs vacíos
                                        }
                                        
                                        // Asegurar que alumnosInfo esté correctamente formateado
                                        let alumnosInfoArray = [];
                                        if (asignacion.alumnosInfo && asignacion.alumnosInfo.length > 0) {
                                          alumnosInfoArray = asignacion.alumnosInfo.map(info => {
                                            // Asegurar que cada objeto tenga la estructura correcta
                                            if (typeof info === 'object' && info !== null) {
                                              return {
                                                id: info.id || info._id || '',
                                                nombre: info.nombre || 'Sin nombre',
                                                idU: info.idU || 'N/P',
                                                cedula: info.cedula || info.idU || 'N/A'
                                              };
                                            }
                                            return null;
                                          }).filter(info => info !== null); // Eliminar entradas nulas
                                        }
                                        
                                        // Preparar los nombres para mostrar
                                        const materiaNombre = asignacion.materiaNombre || (materia ? `${materia.codigo || ''} - ${materia.nombre}` : 'Materia sin nombre');
                                        const profesorNombre = asignacion.profesorNombre || (profesor ? `${profesor.nombre} ${profesor.apellido || ''}` : 'Profesor sin nombre');
                                        
                                        setAsignacionFormData({
                                          id: asignacion.id || asignacion._id,
                                          materiaId: asignacion.materiaId,
                                          materiaNombre: materiaNombre,
                                          profesorId: asignacion.profesorId,
                                          profesorNombre: profesorNombre,
                                          periodo: asignacion.periodo || '',
                                          anio: asignacion.anio || '1 año',
                                          alumnos: alumnosArray,
                                          alumnosInfo: alumnosInfoArray,
                                          modoEdicion: true
                                        });
                                        setShowAsignacionForm(true);
                                      }}
                                      className="p-2 bg-blue-100 rounded-full text-blue-600 hover:bg-blue-200 hover:text-blue-800 transition-all duration-300 transform hover:scale-110"
                                    >
                                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                      </svg>
                                    </button>
                                    <button
                                      onClick={() => {
                                        // Redirigir a la página de calificaciones con el ID de la asignación
                                        const asignacionId = asignacion.id || asignacion._id;
                                        window.location.href = `/calificaciones?id=${asignacionId}`;
                                      }}
                                      className="p-2 bg-green-100 rounded-full text-green-600 hover:bg-green-200 hover:text-green-800 transition-all duration-300 transform hover:scale-110"
                                    >
                                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                      </svg>
                                    </button>
                                    <button
                                      onClick={() => handleDeleteAsignacion(asignacion.id || asignacion._id)}
                                      className="p-2 bg-red-100 rounded-full text-red-600 hover:bg-red-200 hover:text-red-800 transition-all duration-300 transform hover:scale-110"
                                    >
                                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                      </svg>
                                    </button>
                                  </div>
                                </td>
                              </tr>
                            );
                          })
                        : (
                          <tr>
                            <td colSpan="6" className="px-6 py-4 text-center text-sm text-gray-500">
                              No hay asignaciones disponibles. {!Array.isArray(asignaciones) && 'Error al cargar las asignaciones.'}
                            </td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}


            </div>
          </div>
        )}
      </main>
      </div>

      {/* Modales */}
      {showModal && (
        <div className="fixed inset-0 z-50 overflow-y-auto">
          <div className="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div className="fixed inset-0 transition-opacity" aria-hidden="true" onClick={() => setShowModal(false)}>
              <div className="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>

            <span className="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div className="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
              <div className="absolute top-0 right-0 pt-2 pr-2">
                <button
                  type="button"
                  className="text-gray-400 hover:text-gray-500 focus:outline-none"
                  onClick={() => setShowModal(false)}
                >
                  <span className="sr-only">Cerrar</span>
                  <svg className="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              {renderModalContent()}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
